<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Delaware Fence Solutions - CRM</title>
  <script>
    // Prevent dark mode flash - runs synchronously before any CSS loads
    (function() {
      var dm = localStorage.getItem('darkMode');
      if (dm === null || dm === 'true') document.documentElement.classList.add('dark');
    })();
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class'
    }
  </script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    .tab-active { border-bottom: 3px solid #2563eb; color: #2563eb; font-weight: 600; }
    .dark .tab-active { border-bottom: 3px solid #60a5fa; color: #60a5fa; }
  </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // API Configuration
    const API_URL = window.location.origin;
    
    // API Helper Functions
    const api = {
      getToken: () => localStorage.getItem('token'),
      setToken: (token) => localStorage.setItem('token', token),
      clearToken: () => localStorage.removeItem('token'),
      
      getHeaders: () => ({
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${api.getToken()}`
      }),
      
      async request(endpoint, options = {}) {
        const response = await fetch(`${API_URL}${endpoint}`, {
          ...options,
          headers: api.getHeaders()
        });
        
        if (response.status === 401) {
          api.clearToken();
          window.location.reload();
        }
        
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.error || 'Request failed');
        }
        
        return data;
      },
      
      // Auth
      login: (username, password) =>
        fetch(`${API_URL}/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        }).then(r => r.json()),
      
      register: (username, password, name, role) =>
        fetch(`${API_URL}/auth/register`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password, name, role })
        }).then(r => r.json()),
      
      // Companies
      getCompanies: () => api.request('/companies'),
      createCompany: (company) => api.request('/companies', {
        method: 'POST',
        body: JSON.stringify(company)
      }),
      updateCompany: (id, company) => api.request(`/companies/${id}`, {
        method: 'PUT',
        body: JSON.stringify(company)
      }),
      deleteCompany: (id) => api.request(`/companies/${id}`, { method: 'DELETE' }),
      
      // Users (Admin)
      getUsers: () => api.request('/users'),
      updateUser: (id, userData) => api.request(`/users/${id}`, {
        method: 'PUT',
        body: JSON.stringify(userData)
      }),
      deleteUser: (id) => api.request(`/users/${id}`, { method: 'DELETE' }),

      // Activity Logs
      getActivityLogs: (limit = 50) => api.request(`/activity-logs?limit=${limit}`),

      // Exports
      exportCompanies: () => window.location.href = API_URL + '/export/companies',
      exportEmployees: () => window.location.href = API_URL + '/export/employees',

      // Call Script
      getScript: () => api.request('/settings/script'),
      updateScript: (scriptData) => api.request('/settings/script', {
        method: 'PUT',
        body: JSON.stringify(scriptData)
      }),
      // Employees
      getEmployees: () => api.request('/employees'),
      createEmployee: (employee) => api.request('/employees', {
        method: 'POST',
        body: JSON.stringify(employee)
      }),
      updateEmployee: (id, employee) => api.request(`/employees/${id}`, {
        method: 'PUT',
        body: JSON.stringify(employee)
      }),
      deleteEmployee: (id) => api.request(`/employees/${id}`, { method: 'DELETE' }),
      
      // Activities
      getActivities: () => api.request('/activities'),
      createActivity: (activity) => api.request('/activities', {
        method: 'POST',
        body: JSON.stringify(activity)
      }),
      deleteActivity: (id) => api.request(`/activities/${id}`, { method: 'DELETE' }),
      
      // Stats
      getStats: () => api.request('/stats'),

      // Company Notes
      addCompanyNote: (id, text) => api.request(`/companies/${id}/notes`, {
        method: 'POST',
        body: JSON.stringify({ text })
      }),

      // Company Tags
      updateCompanyTags: (id, tags) => api.request(`/companies/${id}/tags`, {
        method: 'PUT',
        body: JSON.stringify({ tags })
      }),
      getAllTags: () => api.request('/tags'),

      // Follow-ups
      updateFollowUp: (id, data) => api.request(`/companies/${id}/follow-up`, {
        method: 'PUT',
        body: JSON.stringify(data)
      }),
      getFollowUps: () => api.request('/follow-ups'),

      // Discover
      discoverCompanies: (query, location) => api.request(`/discover?query=${encodeURIComponent(query)}&location=${encodeURIComponent(location || '')}`),

      // Email
      sendEmail: (data) => api.request('/email/send', { method: 'POST', body: JSON.stringify(data) }),
      getEmailTemplates: () => api.request('/email/templates'),
      createEmailTemplate: (data) => api.request('/email/templates', { method: 'POST', body: JSON.stringify(data) }),
      updateEmailTemplate: (id, data) => api.request(`/email/templates/${id}`, { method: 'PUT', body: JSON.stringify(data) }),
      deleteEmailTemplate: (id) => api.request(`/email/templates/${id}`, { method: 'DELETE' })
    };

    // Reusable Spinner component
    function Spinner({ size = 'md' }) {
      const sizes = { sm: 'h-4 w-4', md: 'h-6 w-6', lg: 'h-8 w-8' };
      return (
        <svg className={`animate-spin ${sizes[size]} text-current`} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
          <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
        </svg>
      );
    }

    // Pagination component
    function Pagination({ currentPage, totalPages, onPageChange }) {
      if (totalPages <= 1) return null;

      const getPages = () => {
        const pages = [];
        const maxVisible = 5;
        let start = Math.max(1, currentPage - Math.floor(maxVisible / 2));
        let end = Math.min(totalPages, start + maxVisible - 1);
        if (end - start + 1 < maxVisible) start = Math.max(1, end - maxVisible + 1);
        for (let i = start; i <= end; i++) pages.push(i);
        return pages;
      };

      return (
        <div className="flex items-center justify-center gap-1 mt-4">
          <button
            onClick={() => onPageChange(currentPage - 1)}
            disabled={currentPage === 1}
            className="px-3 py-1 rounded text-sm border dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700 disabled:opacity-40 disabled:cursor-not-allowed"
          >
            Prev
          </button>
          {getPages().map(page => (
            <button
              key={page}
              onClick={() => onPageChange(page)}
              className={`px-3 py-1 rounded text-sm ${
                page === currentPage
                  ? 'bg-blue-600 text-white'
                  : 'border dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700'
              }`}
            >
              {page}
            </button>
          ))}
          <button
            onClick={() => onPageChange(currentPage + 1)}
            disabled={currentPage === totalPages}
            className="px-3 py-1 rounded text-sm border dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700 disabled:opacity-40 disabled:cursor-not-allowed"
          >
            Next
          </button>
        </div>
      );
    }

    function App() {
      const [isAuthenticated, setIsAuthenticated] = useState(false);
      const [user, setUser] = useState(null);
      const [loading, setLoading] = useState(true);
      const [darkMode, setDarkMode] = useState(true);

      useEffect(() => {
        const token = api.getToken();
        if (token) {
          // Decode JWT payload to restore user data on refresh
          try {
            const payload = JSON.parse(atob(token.split('.')[1]));
            // Check if token is expired
            if (payload.exp && payload.exp * 1000 < Date.now()) {
              api.clearToken();
            } else {
              setUser({ id: payload.id, username: payload.username, name: payload.name || payload.username, role: payload.role, employeeId: payload.employeeId });
              setIsAuthenticated(true);
            }
          } catch (e) {
            // Token malformed, clear it
            api.clearToken();
          }
        }

        // Load dark mode preference (default to true)
        const savedDarkMode = localStorage.getItem('darkMode');
        const isDark = savedDarkMode === null ? true : savedDarkMode === 'true';
        setDarkMode(isDark);
        if (isDark) {
          document.documentElement.classList.add('dark');
        } else {
          document.documentElement.classList.remove('dark');
        }
        
        setLoading(false);
      }, []);

      const toggleDarkMode = () => {
        const newDarkMode = !darkMode;
        setDarkMode(newDarkMode);
        localStorage.setItem('darkMode', newDarkMode.toString());
        if (newDarkMode) {
          document.documentElement.classList.add('dark');
        } else {
          document.documentElement.classList.remove('dark');
        }
      };

      const handleLogin = (userData) => {
        api.setToken(userData.token);
        setUser(userData.user);
        setIsAuthenticated(true);
      };

      const handleLogout = () => {
        api.clearToken();
        setUser(null);
        setIsAuthenticated(false);
      };

      if (loading) {
        return (
          <div className="flex items-center justify-center h-screen bg-gray-50 dark:bg-gray-900">
            <div className="text-blue-600 dark:text-blue-400"><Spinner size="lg" /></div>
          </div>
        );
      }

      if (!isAuthenticated) {
        return <LoginPage onLogin={handleLogin} darkMode={darkMode} toggleDarkMode={toggleDarkMode} />;
      }

      return <MainApp user={user} onLogout={handleLogout} darkMode={darkMode} toggleDarkMode={toggleDarkMode} />;
    }

    // Login Page Component
    function LoginPage({ onLogin, darkMode, toggleDarkMode }) {
      const [username, setUsername] = useState('');
      const [password, setPassword] = useState('');
      const [error, setError] = useState('');
      const [loading, setLoading] = useState(false);

      const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');
        setLoading(true);

        try {
          const data = await api.login(username, password);
          
          if (data.error) {
            setError(data.error);
          } else {
            onLogin(data);
          }
        } catch (err) {
          setError('Login failed. Please try again.');
        } finally {
          setLoading(false);
        }
      };

      return (
        <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-500 to-blue-700 dark:from-gray-800 dark:to-gray-900 relative">
          <button
            onClick={toggleDarkMode}
            className="absolute top-4 right-4 p-2 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 shadow-lg hover:shadow-xl transition-shadow"
            title={darkMode ? 'Switch to Light Mode' : 'Switch to Dark Mode'}
          >
            {darkMode ? '‚òÄÔ∏è' : 'üåô'}
          </button>
          <div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8 max-w-md w-full mx-4">
            <div className="text-center mb-8">
              <h1 className="text-3xl font-bold text-gray-900 dark:text-gray-100">Delaware Fence Solutions</h1>
              <p className="text-gray-600 dark:text-gray-400 mt-2">Contractor CRM</p>
            </div>

            <form onSubmit={handleSubmit} className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Username</label>
                <input
                  type="text"
                  value={username}
                  onChange={(e) => setUsername(e.target.value)}
                  className="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                  placeholder="Enter username"
                  required
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Password</label>
                <input
                  type="password"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  className="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                  placeholder="Enter password"
                  required
                />
              </div>

              {error && (
                <div className="bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800 text-red-700 dark:text-red-400 px-4 py-3 rounded">
                  {error}
                </div>
              )}

              <button
                type="submit"
                disabled={loading}
                className="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition-colors disabled:bg-blue-300 flex items-center justify-center gap-2"
              >
                {loading ? <><Spinner size="sm" /> Logging in...</> : 'Login'}
              </button>
            </form>

            <div className="mt-6 text-center text-sm text-gray-600 dark:text-gray-400">
              <p>Contact your administrator for login credentials.</p>
            </div>
          </div>
        </div>
      );
    }

    // Main Application
    function MainApp({ user, onLogout, darkMode, toggleDarkMode }) {
      const [activeTab, setActiveTab] = useState('dashboard');
      const [companies, setCompanies] = useState([]);
      const [employees, setEmployees] = useState([]);
      const [activities, setActivities] = useState([]);
      const [loading, setLoading] = useState(true);
      const [viewingCompanyId, setViewingCompanyId] = useState(null);

      useEffect(() => {
        loadData();
      }, []);

      const loadData = async () => {
        try {
          const [companiesData, employeesData, activitiesData] = await Promise.all([
            api.getCompanies(),
            api.getEmployees(),
            api.getActivities()
          ]);
          
          setCompanies(companiesData);
          setEmployees(employeesData);
          setActivities(activitiesData);
        } catch (err) {
          console.error('Failed to load data:', err);
          alert('Failed to load data. Please refresh the page.');
        } finally {
          setLoading(false);
        }
      };

      const refreshCompanies = async () => {
        const data = await api.getCompanies();
        setCompanies(data);
      };

      const refreshEmployees = async () => {
        const data = await api.getEmployees();
        setEmployees(data);
      };

      const refreshActivities = async () => {
        const data = await api.getActivities();
        setActivities(data);
      };

      if (loading) {
        return (
          <div className="flex flex-col items-center justify-center h-screen bg-gray-50 dark:bg-gray-900 gap-3">
            <div className="text-blue-600 dark:text-blue-400"><Spinner size="lg" /></div>
            <div className="text-gray-600 dark:text-gray-400">Loading CRM...</div>
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-gray-50 dark:bg-gray-900">
          <header className="bg-blue-600 dark:bg-gray-800 text-white shadow-lg">
            <div className="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
              <div>
                <h1 className="text-2xl font-bold">Delaware Fence Solutions - CRM</h1>
                <p className="text-blue-100 dark:text-gray-400 text-sm">Welcome, {user?.name || 'User'}</p>
              </div>
              <div className="flex items-center gap-3">
                <button
                  onClick={toggleDarkMode}
                  className="p-2 rounded-lg bg-blue-700 dark:bg-gray-700 hover:bg-blue-800 dark:hover:bg-gray-600 transition-colors"
                  title={darkMode ? 'Switch to Light Mode' : 'Switch to Dark Mode'}
                >
                  {darkMode ? '‚òÄÔ∏è' : 'üåô'}
                </button>
                <button
                  onClick={onLogout}
                  className="bg-blue-700 dark:bg-gray-700 hover:bg-blue-800 dark:hover:bg-gray-600 px-4 py-2 rounded-lg transition-colors"
                >
                  Logout
                </button>
              </div>
            </div>
          </header>

          <nav className="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 sticky top-0 z-10">
            <div className="max-w-7xl mx-auto px-4">
              <div className="flex space-x-8">
                {['dashboard', 'calling', 'companies', 'discover', 'activities', 'employees', ...(user?.role === 'admin' ? ['admin'] : [])].map((tab) => (
                  <button
                    key={tab}
                    onClick={() => { setViewingCompanyId(null); setActiveTab(tab); }}
                    className={`py-4 px-2 border-b-3 transition-colors capitalize ${
                      activeTab === tab ? 'tab-active' : 'text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100'
                    }`}
                  >
                    {tab === 'calling' ? 'üìû Calling' : tab === 'discover' ? 'üîç Discover' : tab === 'admin' ? '‚öôÔ∏è Admin' : tab}
                  </button>
                ))}
              </div>
            </div>
          </nav>

          <main className="max-w-7xl mx-auto px-4 py-6 dark:text-gray-100">
            {viewingCompanyId ? (
              <CompanyPage
                companyId={viewingCompanyId}
                companies={companies}
                activities={activities}
                employees={employees}
                user={user}
                onBack={() => setViewingCompanyId(null)}
                onRefresh={async () => {
                  await Promise.all([refreshCompanies(), refreshActivities()]);
                }}
              />
            ) : (
              <>
                {activeTab === 'dashboard' && (
                  <Dashboard
                    companies={companies}
                    activities={activities}
                    employees={employees}
                    setActiveTab={setActiveTab}
                    onViewCompany={setViewingCompanyId}
                  />
                )}
                {activeTab === 'calling' && (
                  <Calling
                    companies={companies}
                    employees={employees}
                    user={user}
                    onActivityAdded={refreshActivities}
                    onCompanyUpdated={refreshCompanies}
                  />
                )}
                {activeTab === 'companies' && (
                  <Companies
                    companies={companies}
                    activities={activities}
                    employees={employees}
                    user={user}
                    onRefresh={refreshCompanies}
                    onActivityAdded={refreshActivities}
                    onViewCompany={setViewingCompanyId}
                  />
                )}
                {activeTab === 'activities' && (
                  <Activities
                    activities={activities}
                    companies={companies}
                    employees={employees}
                    onRefresh={refreshActivities}
                  />
                )}
                {activeTab === 'employees' && (
                  <Employees
                    employees={employees}
                    onRefresh={refreshEmployees}
                  />
                )}
                {activeTab === 'discover' && (
                  <Discover
                    companies={companies}
                    onRefresh={refreshCompanies}
                    onViewCompany={setViewingCompanyId}
                  />
                )}
                {activeTab === 'admin' && user?.role === 'admin' && (
                  <AdminSettings
                    onRefresh={loadData}
                  />
                )}
              </>
            )}
          </main>
        </div>
      );
    }

    // Admin Settings Component
    function AdminSettings({ onRefresh }) {
      const [activeSection, setActiveSection] = useState('users');
      const [users, setUsers] = useState([]);
      const [activityLogs, setActivityLogs] = useState([]);
      const [loading, setLoading] = useState(true);
      const [editingUser, setEditingUser] = useState(null);
      const [showModal, setShowModal] = useState(false);
      const [showScriptEditor, setShowScriptEditor] = useState(false);

      useEffect(() => {
        if (activeSection === 'users') {
          loadUsers();
        } else if (activeSection === 'activity') {
          loadActivityLogs();
        }
      }, [activeSection]);

      const loadUsers = async () => {
        try {
          setLoading(true);
          const data = await api.getUsers();
          setUsers(data);
        } catch (err) {
          console.error('Load users error:', err);
          alert('Failed to load users: ' + (err.message || 'Unknown error'));
        } finally {
          setLoading(false);
        }
      };

      const loadActivityLogs = async () => {
        try {
          setLoading(true);
          const data = await api.getActivityLogs(100);
          setActivityLogs(data);
        } catch (err) {
          console.error('Load activity logs error:', err);
          alert('Failed to load activity logs');
        } finally {
          setLoading(false);
        }
      };

      const handleEdit = (user) => {
        setEditingUser(user);
        setShowModal(true);
      };

      const handleDelete = async (userId) => {
        if (confirm('Are you sure you want to delete this user?')) {
          try {
            await api.deleteUser(userId);
            setUsers(users.filter(u => u.id !== userId));
            alert('User deleted successfully');
          } catch (err) {
            alert('Failed to delete user');
          }
        }
      };

      const handleSave = async (updatedUser) => {
        try {
          await api.updateUser(editingUser.id, updatedUser);
          setUsers(users.map(u => u.id === editingUser.id ? { ...u, ...updatedUser } : u));
          setShowModal(false);
          setEditingUser(null);
          alert('User updated successfully');
        } catch (err) {
          alert('Failed to update user: ' + err.message);
        }
      };

      const handleExport = (type) => {
        if (type === 'companies') {
          api.exportCompanies();
        } else if (type === 'employees') {
          api.exportEmployees();
        }
      };

      return (
        <div className="space-y-6">
          <div className="flex justify-between items-center">
            <h2 className="text-2xl font-bold">‚öôÔ∏è Admin Settings</h2>
          </div>

          {/* Section Tabs */}
          <div className="flex space-x-2 border-b border-gray-300 dark:border-gray-700">
            <button
              onClick={() => setActiveSection('users')}
              className={`px-4 py-2 font-medium ${
                activeSection === 'users'
                  ? 'border-b-2 border-blue-500 text-blue-600 dark:text-blue-400'
                  : 'text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200'
              }`}
            >
              üë• User Management
            </button>
            <button
              onClick={() => setActiveSection('activity')}
              className={`px-4 py-2 font-medium ${
                activeSection === 'activity'
                  ? 'border-b-2 border-blue-500 text-blue-600 dark:text-blue-400'
                  : 'text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200'
              }`}
            >
              üìã Activity Log
            </button>
            <button
              onClick={() => setActiveSection('data')}
              className={`px-4 py-2 font-medium ${
                activeSection === 'data'
                  ? 'border-b-2 border-blue-500 text-blue-600 dark:text-blue-400'
                  : 'text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200'
              }`}
            >
              üíæ Data Export
            </button>
            <button
              onClick={() => setActiveSection('script')}
              className={`px-4 py-2 font-medium ${
                activeSection === 'script'
                  ? 'border-b-2 border-blue-500 text-blue-600 dark:text-blue-400'
                  : 'text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200'
              }`}
            >
              üìù Call Script
            </button>
            <button
              onClick={() => setActiveSection('templates')}
              className={`px-4 py-2 font-medium ${
                activeSection === 'templates'
                  ? 'border-b-2 border-blue-500 text-blue-600 dark:text-blue-400'
                  : 'text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200'
              }`}
            >
              üìß Email Templates
            </button>
          </div>

          {/* User Management Section */}
          {activeSection === 'users' && (
            loading ? (
              <div className="flex items-center justify-center gap-2 text-gray-600 dark:text-gray-400 py-8"><Spinner /> Loading users...</div>
            ) : (
              <div className="bg-white dark:bg-gray-800 rounded-lg shadow overflow-x-auto">
                <table className="w-full">
                  <thead className="bg-gray-50 dark:bg-gray-700">
                    <tr>
                      <th className="px-6 py-3 text-left text-sm font-medium">Username</th>
                      <th className="px-6 py-3 text-left text-sm font-medium">Display Name</th>
                      <th className="px-6 py-3 text-left text-sm font-medium">Role</th>
                      <th className="px-6 py-3 text-left text-sm font-medium">Created</th>
                      <th className="px-6 py-3 text-left text-sm font-medium">Actions</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-gray-200 dark:divide-gray-700">
                    {users.map((user) => (
                      <tr key={user.id} className="hover:bg-gray-50 dark:hover:bg-gray-700">
                        <td className="px-6 py-4 text-sm">{user.username}</td>
                        <td className="px-6 py-4 text-sm">{user.name}</td>
                        <td className="px-6 py-4 text-sm">
                          <span className={`px-2 py-1 rounded text-xs font-medium ${
                            user.role === 'admin'
                              ? 'bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200'
                              : 'bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200'
                          }`}>
                            {user.role}
                          </span>
                        </td>
                        <td className="px-6 py-4 text-sm text-gray-500">
                          {new Date(user.created_at).toLocaleDateString()}
                        </td>
                        <td className="px-6 py-4 text-sm space-x-2">
                          <button
                            onClick={() => handleEdit(user)}
                            className="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm"
                          >
                            Edit
                          </button>
                          {user.id !== 1 && (
                            <button
                              onClick={() => handleDelete(user.id)}
                              className="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-sm"
                            >
                              Delete
                            </button>
                          )}
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )
          )}

          {/* Activity Log Section */}
          {activeSection === 'activity' && (
            loading ? (
              <p className="text-center text-gray-600">Loading activity logs...</p>
            ) : (
              <div className="bg-white dark:bg-gray-800 rounded-lg shadow overflow-x-auto">
                <div className="p-4 border-b border-gray-200 dark:border-gray-700">
                  <p className="text-sm text-gray-600 dark:text-gray-400">
                    Showing last 100 activities
                  </p>
                </div>
                <table className="w-full">
                  <thead className="bg-gray-50 dark:bg-gray-700">
                    <tr>
                      <th className="px-6 py-3 text-left text-sm font-medium">Date/Time</th>
                      <th className="px-6 py-3 text-left text-sm font-medium">User</th>
                      <th className="px-6 py-3 text-left text-sm font-medium">Action</th>
                      <th className="px-6 py-3 text-left text-sm font-medium">Entity</th>
                      <th className="px-6 py-3 text-left text-sm font-medium">Details</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-gray-200 dark:divide-gray-700">
                    {activityLogs.map((log) => (
                      <tr key={log.id} className="hover:bg-gray-50 dark:hover:bg-gray-700">
                        <td className="px-6 py-4 text-sm text-gray-500">
                          {new Date(log.created_at).toLocaleString()}
                        </td>
                        <td className="px-6 py-4 text-sm">
                          {log.users?.name || log.users?.username || 'System'}
                        </td>
                        <td className="px-6 py-4 text-sm">
                          <span className={`px-2 py-1 rounded text-xs font-medium ${
                            log.action_type === 'CREATE' ? 'bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200' :
                            log.action_type === 'UPDATE' ? 'bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200' :
                            log.action_type === 'DELETE' ? 'bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200' :
                            'bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200'
                          }`}>
                            {log.action_type}
                          </span>
                        </td>
                        <td className="px-6 py-4 text-sm capitalize">{log.entity_type}</td>
                        <td className="px-6 py-4 text-sm text-gray-600 dark:text-gray-400">
                          {log.details}
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )
          )}

          {/* Data Export Section */}
          {activeSection === 'data' && (
            <div className="space-y-4">
              <div className="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                <h3 className="text-lg font-semibold mb-4">Export Data to CSV</h3>
                <p className="text-sm text-gray-600 dark:text-gray-400 mb-6">
                  Download your data as CSV files for backup or analysis.
                </p>
                
                <div className="grid md:grid-cols-2 gap-4">
                  <div className="border border-gray-300 dark:border-gray-600 rounded-lg p-6">
                    <div className="flex items-center mb-3">
                      <span className="text-3xl mr-3">üè¢</span>
                      <div>
                        <h4 className="font-semibold">Companies</h4>
                        <p className="text-sm text-gray-600 dark:text-gray-400">
                          All company records with contact info
                        </p>
                      </div>
                    </div>
                    <button
                      onClick={() => handleExport('companies')}
                      className="w-full px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors"
                    >
                      Download Companies CSV
                    </button>
                  </div>

                  <div className="border border-gray-300 dark:border-gray-600 rounded-lg p-6">
                    <div className="flex items-center mb-3">
                      <span className="text-3xl mr-3">üë•</span>
                      <div>
                        <h4 className="font-semibold">Employees</h4>
                        <p className="text-sm text-gray-600 dark:text-gray-400">
                          All employee records with usernames
                        </p>
                      </div>
                    </div>
                    <button
                      onClick={() => handleExport('employees')}
                      className="w-full px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors"
                    >
                      Download Employees CSV
                    </button>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Call Script Editor Section */}
          {activeSection === 'script' && (
            <div className="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
              <div className="flex justify-between items-center mb-4">
                <h3 className="text-lg font-semibold">Call Script Editor</h3>
                <button
                  onClick={() => setShowScriptEditor(true)}
                  className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                >
                  ‚úèÔ∏è Edit Script
                </button>
              </div>
              <p className="text-sm text-gray-600 dark:text-gray-400 mb-4">
                Update the call script that employees see in the Calling tab. Changes are applied immediately for all users.
              </p>
              <div className="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded p-4">
                <p className="text-sm text-blue-800 dark:text-blue-200">
                  üí° <strong>Tip:</strong> Keep the script clear and concise. Include product details, qualifying questions, and a clear call-to-action.
                </p>
              </div>
            </div>
          )}

          {activeSection === 'templates' && (
            <EmailTemplateManager />
          )}

          {showModal && (
            <UserEditModal 
              user={editingUser}
              onClose={() => {
                setShowModal(false);
                setEditingUser(null);
              }}
              onSave={handleSave}
            />
          )}

          {showScriptEditor && (
            <ScriptEditor 
              onClose={() => setShowScriptEditor(false)}
            />
          )}
        </div>
      );
    }

    // User Edit Modal
    function UserEditModal({ user, onClose, onSave }) {
      const [formData, setFormData] = useState({
        username: user.username,
        name: user.name,
        newPassword: ''
      });
      const [saving, setSaving] = useState(false);

      const handleSave = async () => {
        if (!formData.username.trim() || !formData.name.trim()) {
          alert('Username and display name are required');
          return;
        }

        setSaving(true);
        try {
          const updateData = {
            username: formData.username,
            name: formData.name
          };

          if (formData.newPassword.trim()) {
            updateData.password = formData.newPassword;
          }

          await onSave(updateData);
        } finally {
          setSaving(false);
        }
      };

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4">
            <h3 className="text-xl font-bold mb-4">Edit User</h3>
            
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium mb-1">Username</label>
                <input
                  type="text"
                  value={formData.username}
                  onChange={(e) => setFormData({...formData, username: e.target.value})}
                  className="w-full px-3 py-2 border dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                />
              </div>

              <div>
                <label className="block text-sm font-medium mb-1">Display Name</label>
                <input
                  type="text"
                  value={formData.name}
                  onChange={(e) => setFormData({...formData, name: e.target.value})}
                  className="w-full px-3 py-2 border dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                />
              </div>

              <div>
                <label className="block text-sm font-medium mb-1">New Password (leave blank to keep current)</label>
                <input
                  type="password"
                  value={formData.newPassword}
                  onChange={(e) => setFormData({...formData, newPassword: e.target.value})}
                  className="w-full px-3 py-2 border dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                  placeholder="Enter new password or leave blank"
                />
              </div>
            </div>

            <div className="flex gap-3 mt-6">
              <button onClick={onClose} className="flex-1 px-4 py-2 border dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700">
                Cancel
              </button>
              <button
                onClick={handleSave}
                disabled={saving}
                className="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-blue-300"
              >
                {saving ? 'Saving...' : 'Save'}
              </button>
            </div>
          </div>
        </div>
      );
    }

    // Email Template Manager
    function EmailTemplateManager() {
      const [templates, setTemplates] = useState([]);
      const [loading, setLoading] = useState(true);
      const [editing, setEditing] = useState(null);
      const [creating, setCreating] = useState(false);
      const [saving, setSaving] = useState(false);
      const [formData, setFormData] = useState({ name: '', subject: '', body: '' });

      useEffect(() => {
        loadTemplates();
      }, []);

      const loadTemplates = async () => {
        try {
          setLoading(true);
          const data = await api.getEmailTemplates();
          setTemplates(data);
        } catch (err) {
          console.error('Failed to load templates:', err);
        } finally {
          setLoading(false);
        }
      };

      const startEdit = (template) => {
        setEditing(template.id);
        setCreating(false);
        setFormData({ name: template.name, subject: template.subject, body: template.body });
      };

      const startCreate = () => {
        setCreating(true);
        setEditing(null);
        setFormData({ name: '', subject: '', body: '' });
      };

      const cancelEdit = () => {
        setEditing(null);
        setCreating(false);
        setFormData({ name: '', subject: '', body: '' });
      };

      const handleSave = async () => {
        if (!formData.name.trim() || !formData.subject.trim() || !formData.body.trim()) {
          alert('Name, subject, and body are all required');
          return;
        }
        setSaving(true);
        try {
          if (creating) {
            const newTemplate = await api.createEmailTemplate(formData);
            setTemplates([...templates, newTemplate]);
          } else {
            await api.updateEmailTemplate(editing, formData);
            setTemplates(templates.map(t => t.id === editing ? { ...t, ...formData } : t));
          }
          cancelEdit();
        } catch (err) {
          alert('Failed to save template: ' + (err.message || 'Unknown error'));
        } finally {
          setSaving(false);
        }
      };

      const handleDelete = async (id) => {
        if (!confirm('Are you sure you want to delete this template?')) return;
        try {
          await api.deleteEmailTemplate(id);
          setTemplates(templates.filter(t => t.id !== id));
          if (editing === id) cancelEdit();
        } catch (err) {
          alert('Failed to delete template: ' + (err.message || 'Unknown error'));
        }
      };

      // Convert HTML to plain text for textarea
      const htmlToText = (html) => {
        return html
          .replace(/<br\s*\/?>/gi, '\n')
          .replace(/<\/p>/gi, '\n\n')
          .replace(/<\/li>/gi, '\n')
          .replace(/<li[^>]*>/gi, '  - ')
          .replace(/<\/ul>/gi, '\n')
          .replace(/<\/ol>/gi, '\n')
          .replace(/<[^>]+>/g, '')
          .replace(/&amp;/g, '&')
          .replace(/&lt;/g, '<')
          .replace(/&gt;/g, '>')
          .replace(/&mdash;/g, '\u2014')
          .replace(/&nbsp;/g, ' ')
          .replace(/\n{3,}/g, '\n\n')
          .trim();
      };

      const textToHtml = (text) => {
        return text
          .split('\n\n')
          .map(para => `<p>${para.replace(/\n/g, '<br/>')}</p>`)
          .join('\n');
      };

      if (loading) {
        return <div className="flex items-center justify-center gap-2 text-gray-600 dark:text-gray-400 py-8"><Spinner /> Loading templates...</div>;
      }

      return (
        <div className="space-y-4">
          <div className="flex justify-between items-center">
            <div>
              <h3 className="text-lg font-semibold">Email Templates</h3>
              <p className="text-sm text-gray-600 dark:text-gray-400">Manage email templates used when sending emails from company pages.</p>
            </div>
            {!creating && !editing && (
              <button
                onClick={startCreate}
                className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm"
              >
                + New Template
              </button>
            )}
          </div>

          <div className="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded p-3">
            <p className="text-sm text-blue-800 dark:text-blue-200">
              <strong>Available placeholders:</strong> {'{{contact_name}}'}, {'{{sender_name}}'}, {'{{company_name}}'} ‚Äî these get replaced automatically when composing an email.
            </p>
          </div>

          {/* Edit / Create Form */}
          {(editing || creating) && (
            <div className="bg-white dark:bg-gray-800 rounded-lg shadow p-6 border-2 border-blue-500">
              <h4 className="font-semibold mb-4">{creating ? 'Create New Template' : 'Edit Template'}</h4>
              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Template Name</label>
                  <input
                    type="text"
                    value={formData.name}
                    onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                    placeholder="e.g. Introduction Email"
                    className="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Subject Line</label>
                  <input
                    type="text"
                    value={formData.subject}
                    onChange={(e) => setFormData({ ...formData, subject: e.target.value })}
                    placeholder="e.g. Introduction - Delaware Fence Solutions"
                    className="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Email Body</label>
                  <textarea
                    value={formData.body.includes('<') ? htmlToText(formData.body) : formData.body}
                    onChange={(e) => setFormData({ ...formData, body: textToHtml(e.target.value) })}
                    rows={16}
                    placeholder="Type your email template here..."
                    className="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 font-mono text-sm"
                  />
                </div>
                <div className="flex gap-2 justify-end">
                  <button
                    onClick={cancelEdit}
                    className="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 text-sm"
                  >
                    Cancel
                  </button>
                  <button
                    onClick={handleSave}
                    disabled={saving}
                    className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-blue-400 text-sm"
                  >
                    {saving ? 'Saving...' : (creating ? 'Create Template' : 'Save Changes')}
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Template List */}
          <div className="space-y-3">
            {templates.map((template) => (
              <div key={template.id} className={`bg-white dark:bg-gray-800 rounded-lg shadow p-4 ${editing === template.id ? 'ring-2 ring-blue-500' : ''}`}>
                <div className="flex justify-between items-start">
                  <div className="flex-1">
                    <h4 className="font-semibold text-gray-900 dark:text-gray-100">{template.name}</h4>
                    <p className="text-sm text-gray-600 dark:text-gray-400 mt-1">Subject: {template.subject}</p>
                    <p className="text-xs text-gray-500 dark:text-gray-500 mt-1 line-clamp-2">
                      {htmlToText(template.body).substring(0, 150)}...
                    </p>
                  </div>
                  <div className="flex gap-2 ml-4">
                    <button
                      onClick={() => startEdit(template)}
                      disabled={editing || creating}
                      className="px-3 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded hover:bg-blue-200 dark:hover:bg-blue-800 text-sm disabled:opacity-50"
                    >
                      Edit
                    </button>
                    <button
                      onClick={() => handleDelete(template.id)}
                      disabled={editing || creating}
                      className="px-3 py-1 bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300 rounded hover:bg-red-200 dark:hover:bg-red-800 text-sm disabled:opacity-50"
                    >
                      Delete
                    </button>
                  </div>
                </div>
              </div>
            ))}
          </div>

          {templates.length === 0 && (
            <div className="text-center py-8 text-gray-500 dark:text-gray-400">
              No templates yet. Click "+ New Template" to create one.
            </div>
          )}
        </div>
      );
    }

    // Script Editor Modal
    function ScriptEditor({ onClose }) {
      const [script, setScript] = useState(null);
      const [loading, setLoading] = useState(true);
      const [saving, setSaving] = useState(false);

      useEffect(() => {
        loadScript();
      }, []);

      const loadScript = async () => {
        try {
          const data = await api.getScript();
          setScript(data);
        } catch (err) {
          alert('Failed to load script');
        } finally {
          setLoading(false);
        }
      };

      const handleSave = async () => {
        setSaving(true);
        try {
          await api.updateScript(script);
          alert('Script updated successfully!');
          onClose();
        } catch (err) {
          alert('Failed to update script');
        } finally {
          setSaving(false);
        }
      };

      if (loading) {
        return (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div className="bg-white dark:bg-gray-800 rounded-lg p-6">
              <p>Loading script...</p>
            </div>
          </div>
        );
      }

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto">
          <div className="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-4xl w-full mx-4 my-8">
            <h3 className="text-xl font-bold mb-4">Edit Call Script</h3>
            
            <div className="space-y-4 max-h-[70vh] overflow-y-auto pr-2">
              <div>
                <label className="block text-sm font-medium mb-1">Company Name</label>
                <input
                  type="text"
                  value={script.company}
                  onChange={(e) => setScript({ ...script, company: e.target.value })}
                  className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700"
                />
              </div>

              <div>
                <label className="block text-sm font-medium mb-1">Introduction</label>
                <textarea
                  value={script.introduction}
                  onChange={(e) => setScript({ ...script, introduction: e.target.value })}
                  rows="3"
                  className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700"
                />
              </div>

              <div>
                <label className="block text-sm font-medium mb-1">Opening Line</label>
                <textarea
                  value={script.opening}
                  onChange={(e) => setScript({ ...script, opening: e.target.value })}
                  rows="2"
                  className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700"
                />
              </div>

              <div>
                <label className="block text-sm font-medium mb-1">Value Proposition</label>
                <textarea
                  value={script.value_prop}
                  onChange={(e) => setScript({ ...script, value_prop: e.target.value })}
                  rows="2"
                  className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700"
                />
              </div>

              <div>
                <label className="block text-sm font-medium mb-1">Call-to-Action</label>
                <textarea
                  value={script.cta}
                  onChange={(e) => setScript({ ...script, cta: e.target.value })}
                  rows="2"
                  className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700"
                />
              </div>

              <div>
                <label className="block text-sm font-medium mb-2">Products (JSON Array)</label>
                <textarea
                  value={JSON.stringify(script.products, null, 2)}
                  onChange={(e) => {
                    try {
                      setScript({ ...script, products: JSON.parse(e.target.value) });
                    } catch (err) {
                      // Invalid JSON, don't update
                    }
                  }}
                  rows="6"
                  className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 font-mono text-sm"
                  placeholder='[{"name": "Product", "description": "Description"}]'
                />
              </div>

              <div>
                <label className="block text-sm font-medium mb-2">Qualifying Questions (JSON Array)</label>
                <textarea
                  value={JSON.stringify(script.questions, null, 2)}
                  onChange={(e) => {
                    try {
                      setScript({ ...script, questions: JSON.parse(e.target.value) });
                    } catch (err) {
                      // Invalid JSON, don't update
                    }
                  }}
                  rows="4"
                  className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 font-mono text-sm"
                  placeholder='["Question 1", "Question 2"]'
                />
              </div>
            </div>

            <div className="flex space-x-3 mt-6">
              <button
                onClick={onClose}
                className="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700"
              >
                Cancel
              </button>
              <button
                onClick={handleSave}
                disabled={saving}
                className="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-blue-300"
              >
                {saving ? 'Saving...' : 'Save Script'}
              </button>
            </div>
          </div>
        </div>
      );
    }

    // Calling Component
    function Calling({ companies, employees, user, onActivityAdded, onCompanyUpdated }) {
      const [currentIndex, setCurrentIndex] = useState(0);
      const [employee, setEmployee] = useState(user?.employeeId || employees.find(e => e.active)?.id || '');
      const [showScript, setShowScript] = useState(false);
      const [script, setScript] = useState(null);
      const [loadingScript, setLoadingScript] = useState(false);
      const [callData, setCallData] = useState({
        answered: false,
        interested: false,
        notInterested: false,
        leftVoicemail: false,
        sentEmail: false,
        wantsPricing: false,
        wantsCatalog: false,
        needsFollowUp: false,
        notes: ''
      });
      const [saving, setSaving] = useState(false);
      const [filter, setFilter] = useState('all'); // 'all', 'prospects', 'customers'

      // Load script when modal opens
      useEffect(() => {
        if (showScript && !script) {
          loadScript();
        }
      }, [showScript]);

      const loadScript = async () => {
        try {
          setLoadingScript(true);
          const data = await api.getScript();
          setScript(data);
        } catch (err) {
          console.error('Failed to load script:', err);
        } finally {
          setLoadingScript(false);
        }
      };

      // Filter companies based on selected filter
      const filteredCompanies = companies.filter(c => {
        if (filter === 'prospects') return !c.is_customer;
        if (filter === 'customers') return c.is_customer;
        return true;
      });

      const currentCompany = filteredCompanies[currentIndex];

      const resetForm = () => {
        setCallData({
          answered: false,
          interested: false,
          notInterested: false,
          leftVoicemail: false,
          sentEmail: false,
          wantsPricing: false,
          wantsCatalog: false,
          needsFollowUp: false,
          notes: ''
        });
      };

      const handleNext = () => {
        if (currentIndex < filteredCompanies.length - 1) {
          setCurrentIndex(currentIndex + 1);
          resetForm();
        }
      };

      const handlePrevious = () => {
        if (currentIndex > 0) {
          setCurrentIndex(currentIndex - 1);
          resetForm();
        }
      };

      const handleSkip = () => {
        handleNext();
      };

      const handleSaveAndNext = async () => {
        if (!employee) {
          alert('Please select an employee');
          return;
        }

        setSaving(true);
        try {
          // Create activity
          const activity = {
            id: `activity_${Date.now()}`,
            company_id: currentCompany.id,
            employee_id: employee,
            type: 'call',
            answered: callData.answered,
            interested: callData.interested,
            follow_up: callData.needsFollowUp,
            date: new Date().toISOString(),
            notes: callData.notes
          };

          await api.createActivity(activity);

          // Log call outcome as a note via the notes API
          const additions = [];
          if (callData.leftVoicemail) additions.push('Left voicemail');
          if (callData.sentEmail) additions.push('Sent email');
          if (callData.wantsPricing) additions.push('WANTS PRICING');
          if (callData.wantsCatalog) additions.push('WANTS CATALOG');
          if (callData.notInterested) additions.push('Not interested');
          if (callData.answered) additions.push('Answered');
          if (callData.interested) additions.push('Interested');

          const noteText = [
            additions.length > 0 ? additions.join(', ') : null,
            callData.notes ? callData.notes : null
          ].filter(Boolean).join(' - ');

          if (noteText) {
            await api.addCompanyNote(currentCompany.id, noteText);
            await onCompanyUpdated();
          }

          await onActivityAdded();
          resetForm();
          handleNext();
        } catch (err) {
          alert('Failed to save activity');
        } finally {
          setSaving(false);
        }
      };

      if (filteredCompanies.length === 0) {
        return (
          <div className="text-center py-12">
            <p className="text-xl text-gray-600 dark:text-gray-400">No companies to call</p>
          </div>
        );
      }

      if (!currentCompany) {
        return (
          <div className="text-center py-12">
            <p className="text-xl text-gray-600 dark:text-gray-400">All done! üéâ</p>
            <button
              onClick={() => setCurrentIndex(0)}
              className="mt-4 px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
            >
              Start Over
            </button>
          </div>
        );
      }

      return (
        <div className="max-w-4xl mx-auto space-y-6">
          {/* Header */}
          <div className="flex justify-between items-center">
            <h2 className="text-2xl font-bold">üìû Call Queue</h2>
            <div className="flex gap-2">
              <button
                onClick={() => setShowScript(!showScript)}
                className="px-4 py-2 rounded-lg text-sm bg-purple-600 text-white hover:bg-purple-700"
                title="View call script and company info"
              >
                üìã Script
              </button>
              <button
                onClick={() => setFilter('all')}
                className={`px-4 py-2 rounded-lg text-sm ${
                  filter === 'all' 
                    ? 'bg-blue-600 text-white' 
                    : 'bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600'
                }`}
              >
                All ({companies.length})
              </button>
              <button
                onClick={() => { setFilter('prospects'); setCurrentIndex(0); resetForm(); }}
                className={`px-4 py-2 rounded-lg text-sm ${
                  filter === 'prospects' 
                    ? 'bg-blue-600 text-white' 
                    : 'bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600'
                }`}
              >
                Prospects ({companies.filter(c => !c.is_customer).length})
              </button>
              <button
                onClick={() => { setFilter('customers'); setCurrentIndex(0); resetForm(); }}
                className={`px-4 py-2 rounded-lg text-sm ${
                  filter === 'customers' 
                    ? 'bg-blue-600 text-white' 
                    : 'bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600'
                }`}
              >
                Customers ({companies.filter(c => c.is_customer).length})
              </button>
            </div>
          </div>

          {/* Call Script Modal */}
          {showScript && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
              <div className="bg-white dark:bg-gray-800 rounded-lg w-full max-w-6xl max-h-[90vh] overflow-y-auto">
                <div className="p-8 border-b dark:border-gray-700 sticky top-0 bg-white dark:bg-gray-800 flex justify-between items-center">
                  <h3 className="text-2xl font-bold">üìû Cold Call Script - {script?.company || 'Loading...'}</h3>
                  <button onClick={() => setShowScript(false)} className="text-3xl font-bold text-gray-600 hover:text-gray-900 dark:text-gray-400">&times;</button>
                </div>
                <div className="p-8 space-y-6 text-gray-900 dark:text-gray-100">
                  {loadingScript ? (
                    <p className="text-center">Loading script...</p>
                  ) : script ? (
                    <>
                      <div>
                        <h4 className="font-bold text-2xl mb-3">üìç Introduction</h4>
                        <p className="text-base mb-3 leading-relaxed">{script.introduction}</p>
                      </div>

                      <div>
                        <h4 className="font-bold text-2xl mb-3">üéØ Opening</h4>
                        <p className="text-base bg-gray-100 dark:bg-gray-700 p-4 rounded italic mb-3 leading-relaxed">
                          {script.opening}
                        </p>
                      </div>

                      {script.products && script.products.length > 0 && (
                        <div>
                          <h4 className="font-bold text-2xl mb-3">üì¶ Products & Services</h4>
                          <div className="text-base space-y-2 mb-3">
                            {script.products.map((product, idx) => (
                              <div key={idx} className="border-l-4 border-blue-500 pl-4 py-2">
                                <strong className="text-lg">{product.name}</strong>
                                <p className="text-gray-600 dark:text-gray-400">{product.description}</p>
                              </div>
                            ))}
                          </div>
                        </div>
                      )}

                      <div>
                        <h4 className="font-bold text-2xl mb-3">üí¨ Value Proposition</h4>
                        <p className="text-base bg-blue-50 dark:bg-blue-900 p-4 rounded italic mb-3 leading-relaxed">
                          {script.value_prop}
                        </p>
                      </div>

                      {script.questions && script.questions.length > 0 && (
                        <div>
                          <h4 className="font-bold text-2xl mb-3">‚ùì Qualifying Questions</h4>
                          <ul className="text-base space-y-2 list-disc list-inside ml-4 mb-3">
                            {script.questions.map((question, idx) => (
                              <li key={idx}>{question}</li>
                            ))}
                          </ul>
                        </div>
                      )}

                      <div>
                        <h4 className="font-bold text-2xl mb-3">üéÅ Call-to-Action</h4>
                        <p className="text-base bg-green-50 dark:bg-green-900 p-4 rounded italic leading-relaxed">
                          {script.cta}
                        </p>
                      </div>
                    </>
                  ) : (
                    <p className="text-center text-red-600">Failed to load script</p>
                  )}
                </div>
              </div>
            </div>
          )}

          <div className="bg-white dark:bg-gray-800 rounded-lg p-4 shadow">
            <div className="flex justify-between items-center mb-2">
              <span className="text-sm font-medium">Progress</span>
              <span className="text-sm text-gray-600 dark:text-gray-400">
                {currentIndex + 1} / {filteredCompanies.length}
              </span>
            </div>
            <div className="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
              <div
                className="bg-blue-600 h-2 rounded-full transition-all"
                style={{ width: `${((currentIndex + 1) / filteredCompanies.length) * 100}%` }}
              ></div>
            </div>
          </div>

          {/* Company Card */}
          <div className="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
            <div className="mb-6">
              <div className="flex justify-between items-start mb-4">
                <div className="flex-1">
                  <div className="flex items-center gap-3 mb-2">
                    <h3 className="text-2xl font-bold text-gray-900 dark:text-gray-100">
                      {currentCompany.name}
                    </h3>
                    {currentCompany.is_customer ? (
                      <span className="px-4 py-1.5 bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 rounded-full text-sm font-bold shadow-sm">
                        ‚úì CUSTOMER
                      </span>
                    ) : (
                      <span className="px-4 py-1.5 bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 rounded-full text-sm font-bold shadow-sm">
                        üîç PROSPECT
                      </span>
                    )}
                  </div>
                  <p className="text-gray-600 dark:text-gray-400 text-lg">{currentCompany.type}</p>
                  {currentCompany.contact_name && (
                    <div className="mt-2 p-2 bg-blue-50 dark:bg-blue-900/20 rounded-lg inline-block">
                      <span className="text-sm font-medium text-gray-700 dark:text-gray-300">üë§ Contact: </span>
                      <span className="text-sm font-bold text-blue-700 dark:text-blue-300">{currentCompany.contact_name}</span>
                    </div>
                  )}
                </div>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                {currentCompany.phone && (
                  <div>
                    <span className="text-sm font-medium text-gray-700 dark:text-gray-300">üìû Phone:</span>
                    <p className="text-lg font-semibold text-blue-600 dark:text-blue-400">
                      {currentCompany.phone}
                    </p>
                  </div>
                )}
                {currentCompany.address && (
                  <div>
                    <span className="text-sm font-medium text-gray-700 dark:text-gray-300">üìç Address:</span>
                    <p className="text-gray-900 dark:text-gray-100">{currentCompany.address}</p>
                    <p className="text-gray-600 dark:text-gray-400">
                      {currentCompany.city}, {currentCompany.state} {currentCompany.zip}
                    </p>
                  </div>
                )}
                {currentCompany.email && (
                  <div>
                    <span className="text-sm font-medium text-gray-700 dark:text-gray-300">‚úâÔ∏è Email:</span>
                    <p className="text-gray-900 dark:text-gray-100">{currentCompany.email}</p>
                  </div>
                )}
                {currentCompany.website && (
                  <div>
                    <span className="text-sm font-medium text-gray-700 dark:text-gray-300">üåê Website:</span>
                    <p className="text-gray-900 dark:text-gray-100">{currentCompany.website}</p>
                  </div>
                )}
              </div>

              {currentCompany.notes && (
                <div className="p-3 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg">
                  <span className="text-sm font-medium text-gray-700 dark:text-gray-300">üìù Notes:</span>
                  <p className="text-gray-900 dark:text-gray-100 text-sm mt-1 whitespace-pre-wrap">
                    {currentCompany.notes}
                  </p>
                </div>
              )}
            </div>

            <div className="border-t dark:border-gray-700 pt-6 space-y-4">
              <div>
                <label className="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">
                  Calling as:
                </label>
                <select
                  value={employee}
                  onChange={(e) => setEmployee(e.target.value)}
                  className="w-full px-3 py-2 border dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                >
                  {employees.filter(e => e.active).map(emp => (
                    <option key={emp.id} value={emp.id}>{emp.name}</option>
                  ))}
                </select>
              </div>

              <div className="grid grid-cols-2 gap-3">
                <label className="flex items-center p-3 border dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer">
                  <input
                    type="checkbox"
                    checked={callData.answered}
                    onChange={(e) => setCallData({...callData, answered: e.target.checked})}
                    className="mr-3 w-4 h-4"
                  />
                  <span className="text-sm font-medium">‚úì Answered</span>
                </label>

                <label className="flex items-center p-3 border dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer">
                  <input
                    type="checkbox"
                    checked={callData.interested}
                    onChange={(e) => setCallData({...callData, interested: e.target.checked})}
                    className="mr-3 w-4 h-4"
                  />
                  <span className="text-sm font-medium">‚≠ê Interested</span>
                </label>

                <label className="flex items-center p-3 border dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer">
                  <input
                    type="checkbox"
                    checked={callData.notInterested}
                    onChange={(e) => setCallData({...callData, notInterested: e.target.checked})}
                    className="mr-3 w-4 h-4"
                  />
                  <span className="text-sm font-medium">‚úó Not Interested</span>
                </label>

                <label className="flex items-center p-3 border dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer">
                  <input
                    type="checkbox"
                    checked={callData.leftVoicemail}
                    onChange={(e) => setCallData({...callData, leftVoicemail: e.target.checked})}
                    className="mr-3 w-4 h-4"
                  />
                  <span className="text-sm font-medium">üìû Left Voicemail</span>
                </label>

                <label className="flex items-center p-3 border dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer">
                  <input
                    type="checkbox"
                    checked={callData.sentEmail}
                    onChange={(e) => setCallData({...callData, sentEmail: e.target.checked})}
                    className="mr-3 w-4 h-4"
                  />
                  <span className="text-sm font-medium">‚úâÔ∏è Sent Email</span>
                </label>

                <label className="flex items-center p-3 border dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer">
                  <input
                    type="checkbox"
                    checked={callData.wantsPricing}
                    onChange={(e) => setCallData({...callData, wantsPricing: e.target.checked})}
                    className="mr-3 w-4 h-4"
                  />
                  <span className="text-sm font-medium">üí∞ Wants Pricing</span>
                </label>

                <label className="flex items-center p-3 border dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer">
                  <input
                    type="checkbox"
                    checked={callData.wantsCatalog}
                    onChange={(e) => setCallData({...callData, wantsCatalog: e.target.checked})}
                    className="mr-3 w-4 h-4"
                  />
                  <span className="text-sm font-medium">üìö Wants Catalog</span>
                </label>

                <label className="flex items-center p-3 border dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer">
                  <input
                    type="checkbox"
                    checked={callData.needsFollowUp}
                    onChange={(e) => setCallData({...callData, needsFollowUp: e.target.checked})}
                    className="mr-3 w-4 h-4"
                  />
                  <span className="text-sm font-medium">üîî Needs Follow-up</span>
                </label>
              </div>

              <div>
                <label className="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">
                  Call Notes:
                </label>
                <textarea
                  value={callData.notes}
                  onChange={(e) => setCallData({...callData, notes: e.target.value})}
                  rows="3"
                  className="w-full px-3 py-2 border dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                  placeholder="Add notes about this call..."
                />
              </div>
            </div>
          </div>

          {/* Navigation Buttons */}
          <div className="flex gap-3">
            <button
              onClick={handlePrevious}
              disabled={currentIndex === 0}
              className="px-6 py-3 border dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              ‚Üê Previous
            </button>
            <button
              onClick={handleSkip}
              className="flex-1 px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600"
            >
              Skip ‚Üí
            </button>
            <button
              onClick={handleSaveAndNext}
              disabled={saving}
              className="flex-1 px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-green-300 font-semibold flex items-center justify-center gap-2"
            >
              {saving ? <><Spinner size="sm" /> Saving...</> : 'Save & Next ‚Üí'}
            </button>
          </div>
        </div>
      );
    }

    // Dashboard Component
    function Dashboard({ companies, activities, employees, setActiveTab, onViewCompany }) {
      const [stats, setStats] = useState(null);
      const [followUps, setFollowUps] = useState(null);

      useEffect(() => {
        api.getStats().then(setStats);
        api.getFollowUps().then(setFollowUps).catch(() => {});
      }, [activities, companies]);

      if (!stats) return <div className="flex items-center gap-2 text-gray-600 dark:text-gray-400"><Spinner size="sm" /> Loading statistics...</div>;

      const recentActivities = [...activities].slice(0, 5);
      const hasFollowUps = followUps && (followUps.overdue?.length > 0 || followUps.upcoming?.length > 0);

      return (
        <div className="space-y-6">
          <h2 className="text-2xl font-bold">Dashboard Overview</h2>

          <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
            <StatCard title="Total Companies" value={stats.totalCompanies} color="blue" onClick={() => setActiveTab('companies')} />
            <StatCard title="Contacted & Answered" value={stats.contacted} color="green" />
            <StatCard title="Interested" value={stats.interested} color="purple" />
            <StatCard title="Needs Follow-up" value={stats.needsFollowup} color="yellow" />
            <StatCard title="Total Calls" value={stats.totalCalls} color="indigo" />
            <StatCard title="Total Emails" value={stats.totalEmails} color="pink" />
          </div>

          {/* Follow-up Reminders Widget */}
          {hasFollowUps && (
            <div className="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
              <h3 className="text-lg font-semibold mb-4">Follow-up Reminders</h3>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                {/* Overdue */}
                {followUps.overdue?.length > 0 && (
                  <div>
                    <h4 className="text-sm font-medium text-red-600 dark:text-red-400 mb-2 uppercase tracking-wide">
                      Overdue ({followUps.overdue.length})
                    </h4>
                    <div className="space-y-2">
                      {followUps.overdue.slice(0, 5).map(c => (
                        <div key={c.id} className="p-3 bg-red-50 dark:bg-red-900/20 border border-red-100 dark:border-red-900 rounded-lg">
                          <button
                            onClick={() => onViewCompany(c.id)}
                            className="font-medium text-red-700 dark:text-red-300 hover:underline text-sm"
                          >
                            {c.name}
                          </button>
                          <p className="text-xs text-red-500 dark:text-red-400 mt-0.5">
                            Due: {new Date(c.follow_up_date).toLocaleDateString()}
                          </p>
                          {c.follow_up_note && <p className="text-xs text-gray-600 dark:text-gray-400 mt-0.5">{c.follow_up_note}</p>}
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                {/* Upcoming */}
                {followUps.upcoming?.length > 0 && (
                  <div>
                    <h4 className="text-sm font-medium text-blue-600 dark:text-blue-400 mb-2 uppercase tracking-wide">
                      Upcoming ({followUps.upcoming.length})
                    </h4>
                    <div className="space-y-2">
                      {followUps.upcoming.slice(0, 5).map(c => (
                        <div key={c.id} className="p-3 bg-blue-50 dark:bg-blue-900/20 border border-blue-100 dark:border-blue-900 rounded-lg">
                          <button
                            onClick={() => onViewCompany(c.id)}
                            className="font-medium text-blue-700 dark:text-blue-300 hover:underline text-sm"
                          >
                            {c.name}
                          </button>
                          <p className="text-xs text-blue-500 dark:text-blue-400 mt-0.5">
                            Due: {new Date(c.follow_up_date).toLocaleDateString()}
                          </p>
                          {c.follow_up_note && <p className="text-xs text-gray-600 dark:text-gray-400 mt-0.5">{c.follow_up_note}</p>}
                        </div>
                      ))}
                    </div>
                  </div>
                )}
              </div>
            </div>
          )}

          <div className="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
            <h3 className="text-lg font-semibold mb-4">Recent Activities</h3>
            {recentActivities.length === 0 ? (
              <p className="text-gray-500 dark:text-gray-400">No activities yet.</p>
            ) : (
              <div className="space-y-3">
                {recentActivities.map((activity) => {
                  const company = companies.find(c => c.id === activity.company_id);
                  const employee = employees.find(e => e.id === activity.employee_id);
                  return (
                    <div key={activity.id} className="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded">
                      <div className="flex-1">
                        <button
                          onClick={() => company && onViewCompany(company.id)}
                          className="font-medium text-blue-600 dark:text-blue-400 hover:underline"
                        >
                          {company?.name || 'Unknown'}
                        </button>
                        <p className="text-sm text-gray-600 dark:text-gray-400">
                          {activity.type === 'call' ? 'üìû' : '‚úâÔ∏è'} {activity.type} by {employee?.name || 'Unknown'}
                          {activity.answered && ' - Answered'}
                          {activity.interested && ' - Interested'}
                        </p>
                      </div>
                      <span className="text-sm text-gray-500">{new Date(activity.date).toLocaleDateString()}</span>
                    </div>
                  );
                })}
              </div>
            )}
          </div>
        </div>
      );
    }

    function StatCard({ title, value, color, onClick }) {
      const colors = {
        blue: 'bg-blue-50 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300',
        green: 'bg-green-50 text-green-700 dark:bg-green-900/30 dark:text-green-300',
        purple: 'bg-purple-50 text-purple-700 dark:bg-purple-900/30 dark:text-purple-300',
        yellow: 'bg-yellow-50 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-300',
        indigo: 'bg-indigo-50 text-indigo-700 dark:bg-indigo-900/30 dark:text-indigo-300',
        pink: 'bg-pink-50 text-pink-700 dark:bg-pink-900/30 dark:text-pink-300',
      };

      return (
        <div 
          className={`${colors[color]} rounded-lg shadow p-6 ${onClick ? 'cursor-pointer hover:shadow-lg transition-shadow' : ''}`}
          onClick={onClick}
        >
          <h3 className="text-sm font-medium opacity-75">{title}</h3>
          <p className="text-3xl font-bold mt-2">{value}</p>
        </div>
      );
    }

    // Companies Component
    function Companies({ companies, activities, employees, user, onRefresh, onActivityAdded, onViewCompany }) {
      const [search, setSearch] = useState('');
      const [typeFilter, setTypeFilter] = useState('all');
      const [tagFilter, setTagFilter] = useState('all');
      const [selectedCompany, setSelectedCompany] = useState(null);
      const [showActivityModal, setShowActivityModal] = useState(false);
      const [showEditModal, setShowEditModal] = useState(false);
      const [editingCompany, setEditingCompany] = useState(null);
      const [currentPage, setCurrentPage] = useState(1);
      const [allTags, setAllTags] = useState([]);
      const perPage = 25;

      useEffect(() => {
        api.getAllTags().then(setAllTags).catch(() => {});
      }, [companies]);

      const filtered = companies.filter(company => {
        const matchesSearch = company.name.toLowerCase().includes(search.toLowerCase()) ||
                            (company.city || '').toLowerCase().includes(search.toLowerCase());
        const matchesType = typeFilter === 'all' || company.type === typeFilter;
        let matchesTag = true;
        if (tagFilter !== 'all') {
          try {
            const companyTags = JSON.parse(company.tags || '[]');
            matchesTag = companyTags.includes(tagFilter);
          } catch (e) { matchesTag = false; }
        }
        return matchesSearch && matchesType && matchesTag;
      });

      const totalPages = Math.ceil(filtered.length / perPage);
      const paginatedCompanies = filtered.slice((currentPage - 1) * perPage, currentPage * perPage);

      // Reset to page 1 when filters change
      useEffect(() => { setCurrentPage(1); }, [search, typeFilter, tagFilter]);

      const types = [...new Set(companies.map(c => c.type))].filter(Boolean);

      const handleActivitySaved = async () => {
        setShowActivityModal(false);
        setSelectedCompany(null);
        await onActivityAdded();
      };

      const handleEditCompany = (company) => {
        setEditingCompany(company);
        setShowEditModal(true);
      };

      const handleCreateCompany = () => {
        setEditingCompany(null);
        setShowEditModal(true);
      };

      const handleCompanySaved = async () => {
        setShowEditModal(false);
        setEditingCompany(null);
        await onRefresh();
      };

      const calculateDaysSince = (dateString) => {
        if (!dateString) return null;
        const date = new Date(dateString);
        const now = new Date();
        const days = Math.floor((now - date) / (1000 * 60 * 60 * 24));
        return days;
      };

      return (
        <div className="space-y-4">
          <div className="flex justify-between items-center">
            <h2 className="text-2xl font-bold">Companies ({filtered.length})</h2>
            <button
              onClick={handleCreateCompany}
              className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700"
            >
              + Add Company
            </button>
          </div>

          <div className="flex gap-4">
            <input
              type="text"
              placeholder="Search companies..."
              value={search}
              onChange={(e) => setSearch(e.target.value)}
              className="flex-1 px-4 py-2 border dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100"
            />
            <select
              value={typeFilter}
              onChange={(e) => setTypeFilter(e.target.value)}
              className="px-4 py-2 border dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100"
            >
              <option value="all">All Types</option>
              {types.map(type => (
                <option key={type} value={type}>{type}</option>
              ))}
            </select>
            {allTags.length > 0 && (
              <select
                value={tagFilter}
                onChange={(e) => setTagFilter(e.target.value)}
                className="px-4 py-2 border dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100"
              >
                <option value="all">All Tags</option>
                {allTags.map(tag => (
                  <option key={tag} value={tag}>{tag}</option>
                ))}
              </select>
            )}
          </div>

          <div className="bg-white dark:bg-gray-800 rounded-lg shadow overflow-x-auto">
            <table className="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
              <thead className="bg-gray-50 dark:bg-gray-700">
                <tr>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Company</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Type</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Location</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Contact</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Customer</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Status</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Actions</th>
                </tr>
              </thead>
              <tbody className="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                {paginatedCompanies.map((company) => {
                  const companyActivities = activities.filter(a => a.company_id === company.id);
                  const interested = companyActivities.some(a => a.interested);
                  const needsFollowup = companyActivities.some(a => a.follow_up);
                  const daysSinceOrder = calculateDaysSince(company.last_order_date);
                  const daysSinceEstimate = calculateDaysSince(company.last_estimate_date);

                  return (
                    <tr key={company.id} className="hover:bg-gray-50 dark:hover:bg-gray-700">
                      <td className="px-6 py-4">
                        <button
                          onClick={() => onViewCompany(company.id)}
                          className="font-medium text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 hover:underline text-left"
                        >
                          {company.name}
                        </button>
                        {company.website && <div className="text-sm text-gray-500 dark:text-gray-400">{company.website}</div>}
                        {(() => { try { const t = JSON.parse(company.tags || '[]'); return t.length > 0 ? (
                          <div className="flex flex-wrap gap-1 mt-1">{t.map(tag => (
                            <span key={tag} className="px-1.5 py-0.5 text-xs bg-indigo-100 dark:bg-indigo-900 text-indigo-700 dark:text-indigo-300 rounded">{tag}</span>
                          ))}</div>
                        ) : null; } catch(e) { return null; } })()}
                      </td>
                      <td className="px-6 py-4">
                        <span className="px-2 py-1 text-xs font-medium bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 rounded">
                          {company.type}
                        </span>
                      </td>
                      <td className="px-6 py-4 text-sm">{company.city}, {company.state}</td>
                      <td className="px-6 py-4 text-sm">
                        {company.contact_name ? (
                          <div className="font-medium text-gray-900 dark:text-gray-100">üë§ {company.contact_name}</div>
                        ) : (
                          <span className="text-gray-400 dark:text-gray-500 italic">-</span>
                        )}
                        {company.phone && <div className="text-xs text-gray-600 dark:text-gray-400 mt-1">üìû {company.phone}</div>}
                      </td>
                      <td className="px-6 py-4">
                        {company.is_customer ? (
                          <div className="flex flex-col gap-1">
                            <span className="px-2 py-1 text-xs font-medium bg-purple-100 dark:bg-purple-900 text-purple-800 dark:text-purple-200 rounded text-center">Customer</span>
                            {daysSinceOrder !== null && (
                              <span className="text-xs text-gray-600 dark:text-gray-400">Order: {daysSinceOrder}d ago</span>
                            )}
                            {daysSinceEstimate !== null && !company.last_order_date && (
                              <span className="text-xs text-gray-600 dark:text-gray-400">Est: {daysSinceEstimate}d ago</span>
                            )}
                          </div>
                        ) : (
                          <span className="px-2 py-1 text-xs font-medium bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-300 rounded">Prospect</span>
                        )}
                      </td>
                      <td className="px-6 py-4">
                        <div className="flex flex-col gap-1">
                          {interested && <span className="px-2 py-1 text-xs font-medium bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 rounded text-center">Interested</span>}
                          {needsFollowup && <span className="px-2 py-1 text-xs font-medium bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200 rounded text-center">Follow-up</span>}
                          {companyActivities.length === 0 && <span className="px-2 py-1 text-xs font-medium bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-300 rounded text-center">Not Contacted</span>}
                        </div>
                      </td>
                      <td className="px-6 py-4">
                        <div className="flex gap-2">
                          <button
                            onClick={() => handleEditCompany(company)}
                            className="text-blue-600 dark:text-blue-400 hover:text-blue-900 dark:hover:text-blue-300 font-medium text-sm"
                          >
                            Edit
                          </button>
                          <button
                            onClick={() => {
                              setSelectedCompany(company);
                              setShowActivityModal(true);
                            }}
                            className="text-green-600 dark:text-green-400 hover:text-green-900 dark:hover:text-green-300 font-medium text-sm"
                          >
                            Log Activity
                          </button>
                        </div>
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>

          <Pagination currentPage={currentPage} totalPages={totalPages} onPageChange={setCurrentPage} />

          {showActivityModal && selectedCompany && (
            <ActivityModal
              company={selectedCompany}
              employees={employees}
              user={user}
              onClose={() => {
                setShowActivityModal(false);
                setSelectedCompany(null);
              }}
              onSave={handleActivitySaved}
            />
          )}
          
          {showEditModal && (
            <CompanyEditModal
              company={editingCompany}
              onClose={() => {
                setShowEditModal(false);
                setEditingCompany(null);
              }}
              onSave={handleCompanySaved}
            />
          )}
        </div>
      );
    }

    // Activities Component
    function Activities({ activities, companies, employees, onRefresh }) {
      const [filter, setFilter] = useState('all');
      const [currentPage, setCurrentPage] = useState(1);
      const perPage = 20;

      const filtered = activities.filter(activity => {
        if (filter === 'all') return true;
        if (filter === 'calls') return activity.type === 'call';
        if (filter === 'emails') return activity.type === 'email';
        if (filter === 'interested') return activity.interested;
        if (filter === 'followup') return activity.follow_up;
        return true;
      });

      const totalPages = Math.ceil(filtered.length / perPage);
      const paginatedActivities = filtered.slice((currentPage - 1) * perPage, currentPage * perPage);

      // Reset to page 1 when filter changes
      useEffect(() => { setCurrentPage(1); }, [filter]);

      const deleteActivity = async (id) => {
        if (confirm('Delete this activity?')) {
          try {
            await api.deleteActivity(id);
            await onRefresh();
          } catch (err) {
            alert('Failed to delete activity');
          }
        }
      };

      return (
        <div className="space-y-4">
          <h2 className="text-2xl font-bold">Activity Log ({filtered.length})</h2>

          <div className="flex gap-2">
            {[
              { value: 'all', label: 'All' },
              { value: 'calls', label: 'Calls' },
              { value: 'emails', label: 'Emails' },
              { value: 'interested', label: 'Interested' },
              { value: 'followup', label: 'Follow-up' }
            ].map(({ value, label }) => (
              <button
                key={value}
                onClick={() => setFilter(value)}
                className={`px-4 py-2 rounded-lg font-medium ${
                  filter === value ? 'bg-blue-600 text-white' : 'bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700'
                }`}
              >
                {label}
              </button>
            ))}
          </div>

          <div className="bg-white dark:bg-gray-800 rounded-lg shadow overflow-x-auto">
            {filtered.length === 0 ? (
              <div className="p-8 text-center text-gray-500 dark:text-gray-400">No activities found</div>
            ) : (
              <table className="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                <thead className="bg-gray-50 dark:bg-gray-700">
                  <tr>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Company</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Employee</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Result</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Notes</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                  </tr>
                </thead>
                <tbody className="divide-y divide-gray-200">
                  {paginatedActivities.map((activity) => {
                    const company = companies.find(c => c.id === activity.company_id);
                    const employee = employees.find(e => e.id === activity.employee_id);
                    
                    return (
                      <tr key={activity.id} className="hover:bg-gray-50 dark:hover:bg-gray-700">
                        <td className="px-6 py-4 text-sm">{new Date(activity.date).toLocaleDateString()}</td>
                        <td className="px-6 py-4 font-medium">{company?.name || 'Unknown'}</td>
                        <td className="px-6 py-4">
                          <span className={`px-2 py-1 text-xs font-medium rounded ${
                            activity.type === 'call' ? 'bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200' : 'bg-purple-100 dark:bg-purple-900 text-purple-800 dark:text-purple-200'
                          }`}>
                            {activity.type === 'call' ? 'üìû Call' : '‚úâÔ∏è Email'}
                          </span>
                        </td>
                        <td className="px-6 py-4 text-sm">{employee?.name || 'Unknown'}</td>
                        <td className="px-6 py-4">
                          <div className="flex flex-col gap-1">
                            {activity.answered && <span className="px-2 py-1 text-xs font-medium bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 rounded text-center">Answered</span>}
                            {activity.interested && <span className="px-2 py-1 text-xs font-medium bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 rounded text-center">Interested</span>}
                            {activity.follow_up && <span className="px-2 py-1 text-xs font-medium bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200 rounded text-center">Follow-up</span>}
                            {!activity.answered && <span className="px-2 py-1 text-xs font-medium bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-300 rounded text-center">No Answer</span>}
                          </div>
                        </td>
                        <td className="px-6 py-4 text-sm max-w-xs truncate">{activity.notes || '-'}</td>
                        <td className="px-6 py-4">
                          <button onClick={() => deleteActivity(activity.id)} className="text-red-600 dark:text-red-400 hover:text-red-900 dark:hover:text-red-300 text-sm">
                            Delete
                          </button>
                        </td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            )}
          </div>

          <Pagination currentPage={currentPage} totalPages={totalPages} onPageChange={setCurrentPage} />
        </div>
      );
    }

    // Employees Component
    function Employees({ employees, onRefresh }) {
      const [showModal, setShowModal] = useState(false);
      const [editingEmployee, setEditingEmployee] = useState(null);

      const handleEdit = (employee) => {
        setEditingEmployee(employee);
        setShowModal(true);
      };

      const handleCreate = () => {
        setEditingEmployee(null);
        setShowModal(true);
      };

      const handleSaved = async () => {
        setShowModal(false);
        setEditingEmployee(null);
        await onRefresh();
      };

      const toggleActive = async (employee) => {
        try {
          await api.updateEmployee(employee.id, { ...employee, active: !employee.active });
          await onRefresh();
        } catch (err) {
          alert('Failed to update employee');
        }
      };

      const deleteEmployee = async (id) => {
        if (confirm('Delete this employee?')) {
          try {
            await api.deleteEmployee(id);
            await onRefresh();
          } catch (err) {
            alert('Failed to delete employee');
          }
        }
      };

      return (
        <div className="space-y-4">
          <div className="flex justify-between items-center">
            <h2 className="text-2xl font-bold">Team Members ({employees.length})</h2>
            <button
              onClick={handleCreate}
              className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700"
            >
              + Add Employee
            </button>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {employees.map((employee) => (
              <div key={employee.id} className="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                <div className="flex justify-between items-start mb-4">
                  <div>
                    <h3 className="font-semibold text-lg">{employee.name}</h3>
                    <p className="text-sm text-gray-600 dark:text-gray-400">{employee.role}</p>
                  </div>
                  <span className={`px-2 py-1 text-xs font-medium rounded ${
                    employee.active ? 'bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200' : 'bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-300'
                  }`}>
                    {employee.active ? 'Active' : 'Inactive'}
                  </span>
                </div>
                <div className="flex gap-2">
                  <button
                    onClick={() => handleEdit(employee)}
                    className="flex-1 px-3 py-2 text-sm border dark:border-gray-600 rounded hover:bg-gray-50 dark:hover:bg-gray-700"
                  >
                    Edit
                  </button>
                  <button
                    onClick={() => toggleActive(employee)}
                    className="flex-1 px-3 py-2 text-sm border dark:border-gray-600 rounded hover:bg-gray-50 dark:hover:bg-gray-700"
                  >
                    {employee.active ? 'Deactivate' : 'Activate'}
                  </button>
                  <button
                    onClick={() => deleteEmployee(employee.id)}
                    className="px-3 py-2 text-sm text-red-600 dark:text-red-400 border border-red-300 dark:border-red-800 rounded hover:bg-red-50 dark:hover:bg-red-900/30"
                  >
                    Delete
                  </button>
                </div>
              </div>
            ))}
          </div>

          {showModal && (
            <EmployeeEditModal
              employee={editingEmployee}
              onClose={() => {
                setShowModal(false);
                setEditingEmployee(null);
              }}
              onSave={handleSaved}
            />
          )}
        </div>
      );
    }

    // Activity Modal
    function ActivityModal({ company, employees, user, onClose, onSave }) {
      const [activity, setActivity] = useState({
        type: 'call',
        employee_id: user?.employeeId || employees.find(e => e.active)?.id || '',
        answered: false,
        interested: false,
        follow_up: false,
        notes: ''
      });
      const [saving, setSaving] = useState(false);

      const handleSave = async () => {
        if (!activity.employee_id) {
          alert('Please select an employee');
          return;
        }
        
        setSaving(true);
        try {
          const newActivity = {
            id: `activity_${Date.now()}`,
            company_id: company.id,
            ...activity,
            date: new Date().toISOString()
          };
          
          await api.createActivity(newActivity);
          await onSave();
        } catch (err) {
          alert('Failed to save activity');
        } finally {
          setSaving(false);
        }
      };

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4">
            <h3 className="text-xl font-bold mb-4 text-gray-900 dark:text-gray-100">Log Activity - {company.name}</h3>
            
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">Type</label>
                <select
                  value={activity.type}
                  onChange={(e) => setActivity({...activity, type: e.target.value})}
                  className="w-full px-3 py-2 border dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                >
                  <option value="call">Phone Call</option>
                  <option value="email">Email</option>
                </select>
              </div>

              <div>
                <label className="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">Employee</label>
                <select
                  value={activity.employee_id}
                  onChange={(e) => setActivity({...activity, employee_id: e.target.value})}
                  className="w-full px-3 py-2 border dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                >
                  {employees.filter(e => e.active).map(emp => (
                    <option key={emp.id} value={emp.id}>{emp.name}</option>
                  ))}
                </select>
              </div>

              <div className="space-y-2">
                <label className="flex items-center">
                  <input
                    type="checkbox"
                    checked={activity.answered}
                    onChange={(e) => setActivity({...activity, answered: e.target.checked})}
                    className="mr-2"
                  />
                  <span className="text-sm text-gray-700 dark:text-gray-300">They answered/responded</span>
                </label>
                
                <label className="flex items-center">
                  <input
                    type="checkbox"
                    checked={activity.interested}
                    onChange={(e) => setActivity({...activity, interested: e.target.checked})}
                    className="mr-2"
                  />
                  <span className="text-sm text-gray-700 dark:text-gray-300">They are interested</span>
                </label>
                
                <label className="flex items-center">
                  <input
                    type="checkbox"
                    checked={activity.follow_up}
                    onChange={(e) => setActivity({...activity, follow_up: e.target.checked})}
                    className="mr-2"
                  />
                  <span className="text-sm text-gray-700 dark:text-gray-300">Needs follow-up</span>
                </label>
              </div>

              <div>
                <label className="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">Notes</label>
                <textarea
                  value={activity.notes}
                  onChange={(e) => setActivity({...activity, notes: e.target.value})}
                  rows="3"
                  className="w-full px-3 py-2 border dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                  placeholder="Add notes..."
                />
              </div>
            </div>

            <div className="flex gap-3 mt-6">
              <button onClick={onClose} className="flex-1 px-4 py-2 border dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 text-gray-900 dark:text-gray-100">
                Cancel
              </button>
              <button
                onClick={handleSave}
                disabled={saving}
                className="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-blue-300 flex items-center justify-center gap-2"
              >
                {saving ? <><Spinner size="sm" /> Saving...</> : 'Save Activity'}
              </button>
            </div>
          </div>
        </div>
      );
    }

    // Company Edit Modal
    function CompanyEditModal({ company, onClose, onSave }) {
      const isEdit = !!company;
      const [formData, setFormData] = useState(company || {
        name: '',
        type: 'General Contractor',
        contact_name: '',
        address: '',
        city: '',
        state: 'DE',
        zip: '',
        phone: '',
        email: '',
        website: '',
        notes: '',
        is_customer: false,
        last_order_date: '',
        last_estimate_date: ''
      });
      const [saving, setSaving] = useState(false);

      const handleSave = async () => {
        if (!formData.name.trim()) {
          alert('Please enter a company name');
          return;
        }
        
        setSaving(true);
        try {
          if (isEdit) {
            await api.updateCompany(company.id, formData);
          } else {
            const newCompany = {
              id: `company_${Date.now()}`,
              ...formData
            };
            await api.createCompany(newCompany);
          }
          await onSave();
        } catch (err) {
          console.error('Save error:', err);
          alert(`Failed to ${isEdit ? 'update' : 'create'} company: ${err.message}`);
        } finally {
          setSaving(false);
        }
      };

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto">
          <div className="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-2xl w-full mx-4 my-8">
            <h3 className="text-xl font-bold mb-4 text-gray-900 dark:text-gray-100">{isEdit ? 'Edit Company' : 'Add New Company'}</h3>
            
            <div className="space-y-4 max-h-96 overflow-y-auto">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="md:col-span-2">
                  <label className="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">Company Name *</label>
                  <input
                    type="text"
                    value={formData.name}
                    onChange={(e) => setFormData({...formData, name: e.target.value})}
                    className="w-full px-3 py-2 border dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">Type</label>
                  <input
                    type="text"
                    value={formData.type}
                    onChange={(e) => setFormData({...formData, type: e.target.value})}
                    className="w-full px-3 py-2 border dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">Contact Name</label>
                  <input
                    type="text"
                    value={formData.contact_name || ''}
                    onChange={(e) => setFormData({...formData, contact_name: e.target.value})}
                    className="w-full px-3 py-2 border dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                    placeholder="Main contact person"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">Phone</label>
                  <input
                    type="text"
                    value={formData.phone}
                    onChange={(e) => setFormData({...formData, phone: e.target.value})}
                    className="w-full px-3 py-2 border dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                  />
                </div>

                <div className="md:col-span-2">
                  <label className="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">Address</label>
                  <input
                    type="text"
                    value={formData.address}
                    onChange={(e) => setFormData({...formData, address: e.target.value})}
                    className="w-full px-3 py-2 border dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">City</label>
                  <input
                    type="text"
                    value={formData.city}
                    onChange={(e) => setFormData({...formData, city: e.target.value})}
                    className="w-full px-3 py-2 border dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">State</label>
                  <input
                    type="text"
                    value={formData.state}
                    onChange={(e) => setFormData({...formData, state: e.target.value})}
                    className="w-full px-3 py-2 border dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">ZIP</label>
                  <input
                    type="text"
                    value={formData.zip}
                    onChange={(e) => setFormData({...formData, zip: e.target.value})}
                    className="w-full px-3 py-2 border dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">Email</label>
                  <input
                    type="email"
                    value={formData.email}
                    onChange={(e) => setFormData({...formData, email: e.target.value})}
                    className="w-full px-3 py-2 border dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                  />
                </div>

                <div className="md:col-span-2">
                  <label className="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">Website</label>
                  <input
                    type="text"
                    value={formData.website}
                    onChange={(e) => setFormData({...formData, website: e.target.value})}
                    className="w-full px-3 py-2 border dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                  />
                </div>

                <div className="md:col-span-2">
                  <label className="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">Notes</label>
                  <textarea
                    value={formData.notes}
                    onChange={(e) => setFormData({...formData, notes: e.target.value})}
                    rows="3"
                    className="w-full px-3 py-2 border dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                  />
                </div>

                <div className="md:col-span-2">
                  <label className="flex items-center">
                    <input
                      type="checkbox"
                      checked={formData.is_customer}
                      onChange={(e) => setFormData({...formData, is_customer: e.target.checked})}
                      className="mr-2"
                    />
                    <span className="text-sm text-gray-700 dark:text-gray-300">Current Customer</span>
                  </label>
                </div>

                {formData.is_customer && (
                  <>
                    <div>
                      <label className="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">Last Order Date</label>
                      <input
                        type="date"
                        value={formData.last_order_date || ''}
                        onChange={(e) => setFormData({...formData, last_order_date: e.target.value})}
                        className="w-full px-3 py-2 border dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                      />
                    </div>

                    <div>
                      <label className="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">Last Estimate Date</label>
                      <input
                        type="date"
                        value={formData.last_estimate_date || ''}
                        onChange={(e) => setFormData({...formData, last_estimate_date: e.target.value})}
                        className="w-full px-3 py-2 border dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                      />
                    </div>
                  </>
                )}
              </div>
            </div>

            <div className="flex gap-3 mt-6">
              <button onClick={onClose} className="flex-1 px-4 py-2 border dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 text-gray-900 dark:text-gray-100">
                Cancel
              </button>
              <button
                onClick={handleSave}
                disabled={saving}
                className="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-blue-300 flex items-center justify-center gap-2"
              >
                {saving ? <><Spinner size="sm" /> Saving...</> : (isEdit ? 'Update Company' : 'Add Company')}
              </button>
            </div>
          </div>
        </div>
      );
    }

    // Employee Edit Modal
    function EmployeeEditModal({ employee, onClose, onSave }) {
      const isEdit = !!employee;
      const [formData, setFormData] = useState(employee || {
        name: '',
        role: 'Sales Rep',
        active: true,
        username: '',
        password: ''
      });
      const [saving, setSaving] = useState(false);

      const handleSave = async () => {
        if (!formData.name.trim()) {
          alert('Please enter a name');
          return;
        }
        
        if (!isEdit && (!formData.username.trim() || !formData.password.trim())) {
          alert('Please enter username and password for new employee');
          return;
        }
        
        setSaving(true);
        try {
          if (isEdit) {
            await api.updateEmployee(employee.id, formData);
          } else {
            const newEmployee = {
              id: `emp_${Date.now()}`,
              ...formData
            };
            await api.createEmployee(newEmployee);
          }
          await onSave();
        } catch (err) {
          alert(`Failed to ${isEdit ? 'update' : 'create'} employee`);
        } finally {
          setSaving(false);
        }
      };

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4">
            <h3 className="text-xl font-bold mb-4 text-gray-900 dark:text-gray-100">{isEdit ? 'Edit Employee' : 'Add New Employee'}</h3>
            
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">Name *</label>
                <input
                  type="text"
                  value={formData.name}
                  onChange={(e) => setFormData({...formData, name: e.target.value})}
                  className="w-full px-3 py-2 border dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                />
              </div>

              <div>
                <label className="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">Role</label>
                <input
                  type="text"
                  value={formData.role}
                  onChange={(e) => setFormData({...formData, role: e.target.value})}
                  className="w-full px-3 py-2 border dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                  placeholder="Sales Rep"
                />
              </div>

              {!isEdit && (
                <>
                  <div>
                    <label className="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">Username *</label>
                    <input
                      type="text"
                      value={formData.username}
                      onChange={(e) => setFormData({...formData, username: e.target.value})}
                      className="w-full px-3 py-2 border dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                      placeholder="Login username"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">Password *</label>
                    <input
                      type="password"
                      value={formData.password}
                      onChange={(e) => setFormData({...formData, password: e.target.value})}
                      className="w-full px-3 py-2 border dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                      placeholder="Login password"
                    />
                  </div>
                </>
              )}

              {isEdit && (
                <div>
                  <label className="flex items-center">
                    <input
                      type="checkbox"
                      checked={formData.active}
                      onChange={(e) => setFormData({...formData, active: e.target.checked})}
                      className="mr-2"
                    />
                    <span className="text-sm text-gray-700 dark:text-gray-300">Active Employee</span>
                  </label>
                </div>
              )}
            </div>

            <div className="flex gap-3 mt-6">
              <button onClick={onClose} className="flex-1 px-4 py-2 border dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 text-gray-900 dark:text-gray-100">
                Cancel
              </button>
              <button
                onClick={handleSave}
                disabled={saving}
                className="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-blue-300 flex items-center justify-center gap-2"
              >
                {saving ? <><Spinner size="sm" /> Saving...</> : (isEdit ? 'Update Employee' : 'Add Employee')}
              </button>
            </div>
          </div>
        </div>
      );
    }

    // Full-page Company View
    function CompanyPage({ companyId, companies, activities, employees, user, onBack, onRefresh }) {
      const [activeSection, setActiveSection] = useState('info');
      const [newNote, setNewNote] = useState('');
      const [savingNote, setSavingNote] = useState(false);
      const [showEditModal, setShowEditModal] = useState(false);
      const [showActivityModal, setShowActivityModal] = useState(false);
      const [showEmailModal, setShowEmailModal] = useState(false);
      const [newTag, setNewTag] = useState('');
      const [savingTags, setSavingTags] = useState(false);
      const [suggestedTags, setSuggestedTags] = useState([]);
      const [followUpDate, setFollowUpDate] = useState('');
      const [followUpNote, setFollowUpNote] = useState('');
      const [savingFollowUp, setSavingFollowUp] = useState(false);
      const [editingFollowUp, setEditingFollowUp] = useState(false);

      const company = companies.find(c => c.id === companyId);
      const companyActivities = activities.filter(a => a.company_id === companyId).sort((a, b) => new Date(b.date) - new Date(a.date));

      useEffect(() => {
        api.getAllTags().then(setSuggestedTags).catch(() => {});
      }, []);

      useEffect(() => {
        if (company) {
          setFollowUpDate(company.follow_up_date ? company.follow_up_date.split('T')[0] : '');
          setFollowUpNote(company.follow_up_note || '');
        }
      }, [company?.follow_up_date, company?.follow_up_note]);

      if (!company) {
        return (
          <div className="text-center py-12">
            <p className="text-gray-600 dark:text-gray-400">Company not found.</p>
            <button onClick={onBack} className="mt-4 text-blue-600 dark:text-blue-400 hover:underline">Go back</button>
          </div>
        );
      }

      // Parse notes
      let notesArr = [];
      const rawNotes = company.notes || '';
      if (rawNotes.trim().startsWith('[')) {
        try { notesArr = JSON.parse(rawNotes); } catch (e) {}
      } else if (rawNotes.trim()) {
        notesArr = [{ id: 'legacy_1', author: 'System', text: rawNotes, timestamp: company.created_at }];
      }

      // Parse tags
      let companyTags = [];
      try { companyTags = JSON.parse(company.tags || '[]'); } catch (e) {}

      const calculateDaysSince = (dateString) => {
        if (!dateString) return null;
        return Math.floor((new Date() - new Date(dateString)) / (1000 * 60 * 60 * 24));
      };

      const daysSinceOrder = calculateDaysSince(company.last_order_date);
      const daysSinceEstimate = calculateDaysSince(company.last_estimate_date);

      const handleAddNote = async () => {
        if (!newNote.trim()) return;
        setSavingNote(true);
        try {
          await api.addCompanyNote(company.id, newNote);
          setNewNote('');
          await onRefresh();
        } catch (err) {
          alert('Failed to add note');
        } finally {
          setSavingNote(false);
        }
      };

      const handleAddTag = async (tag) => {
        const tagToAdd = (tag || newTag).trim();
        if (!tagToAdd || companyTags.includes(tagToAdd)) return;
        setSavingTags(true);
        try {
          await api.updateCompanyTags(company.id, [...companyTags, tagToAdd]);
          setNewTag('');
          await onRefresh();
        } catch (err) {
          alert('Failed to add tag');
        } finally {
          setSavingTags(false);
        }
      };

      const handleRemoveTag = async (tag) => {
        setSavingTags(true);
        try {
          await api.updateCompanyTags(company.id, companyTags.filter(t => t !== tag));
          await onRefresh();
        } catch (err) {
          alert('Failed to remove tag');
        } finally {
          setSavingTags(false);
        }
      };

      const handleSaveFollowUp = async () => {
        setSavingFollowUp(true);
        try {
          await api.updateFollowUp(company.id, {
            follow_up_date: followUpDate || null,
            follow_up_note: followUpNote || null
          });
          setEditingFollowUp(false);
          await onRefresh();
        } catch (err) {
          alert('Failed to update follow-up');
        } finally {
          setSavingFollowUp(false);
        }
      };

      const handleClearFollowUp = async () => {
        setSavingFollowUp(true);
        try {
          await api.updateFollowUp(company.id, { follow_up_date: null, follow_up_note: null });
          setFollowUpDate('');
          setFollowUpNote('');
          setEditingFollowUp(false);
          await onRefresh();
        } catch (err) {
          alert('Failed to clear follow-up');
        } finally {
          setSavingFollowUp(false);
        }
      };

      const isOverdue = company.follow_up_date && company.follow_up_date.split('T')[0] < new Date().toISOString().split('T')[0];

      const defaultSuggestions = ['Hot Lead', 'VIP', 'Needs Quote', 'Needs Follow-up', 'Not Interested', 'Pricing Sent'];
      const allSuggestions = [...new Set([...defaultSuggestions, ...suggestedTags])].filter(t => !companyTags.includes(t));

      const sections = ['info', 'notes', 'activities'];

      return (
        <div className="space-y-4">
          {/* Header */}
          <div className="flex justify-between items-start">
            <div>
              <button onClick={onBack} className="text-sm text-blue-600 dark:text-blue-400 hover:underline mb-2 inline-flex items-center gap-1">
                ‚Üê Back to Companies
              </button>
              <div className="flex items-center gap-3">
                <h2 className="text-2xl font-bold text-gray-900 dark:text-gray-100">{company.name}</h2>
                <span className={`px-3 py-1 rounded-full text-sm font-medium ${
                  company.is_customer
                    ? 'bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200'
                    : 'bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-300'
                }`}>
                  {company.is_customer ? '‚úì Customer' : 'Prospect'}
                </span>
              </div>
              <p className="text-gray-600 dark:text-gray-400">{company.type} {company.city && company.state ? `‚Ä¢ ${company.city}, ${company.state}` : ''}</p>
            </div>
            <div className="flex gap-2">
              <button
                onClick={() => setShowEmailModal(true)}
                className="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 text-sm"
              >
                Send Email
              </button>
              <button
                onClick={() => setShowActivityModal(true)}
                className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm"
              >
                Log Activity
              </button>
              <button
                onClick={() => setShowEditModal(true)}
                className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm"
              >
                Edit
              </button>
            </div>
          </div>

          {/* Section Tabs */}
          <div className="flex space-x-1 border-b border-gray-200 dark:border-gray-700">
            {sections.map(s => (
              <button
                key={s}
                onClick={() => setActiveSection(s)}
                className={`px-4 py-2 font-medium text-sm capitalize ${
                  activeSection === s
                    ? 'border-b-2 border-blue-500 text-blue-600 dark:text-blue-400'
                    : 'text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200'
                }`}
              >
                {s === 'info' ? 'Info' : s === 'notes' ? `Notes (${notesArr.length})` : `Activities (${companyActivities.length})`}
              </button>
            ))}
          </div>

          {/* Info Section */}
          {activeSection === 'info' && (
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
              {/* Left: Contact Details */}
              <div className="lg:col-span-2 space-y-6">
                <div className="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                  <h3 className="text-lg font-semibold mb-4 text-gray-900 dark:text-gray-100">Contact Information</h3>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                    {company.contact_name && (
                      <div>
                        <span className="font-medium text-gray-500 dark:text-gray-400">Contact</span>
                        <p className="text-gray-900 dark:text-gray-100 font-medium">{company.contact_name}</p>
                      </div>
                    )}
                    {company.phone && (
                      <div>
                        <span className="font-medium text-gray-500 dark:text-gray-400">Phone</span>
                        <p className="text-blue-600 dark:text-blue-400 font-medium">{company.phone}</p>
                      </div>
                    )}
                    {company.email && (
                      <div>
                        <span className="font-medium text-gray-500 dark:text-gray-400">Email</span>
                        <p className="text-gray-900 dark:text-gray-100">{company.email}</p>
                      </div>
                    )}
                    {company.website && (
                      <div>
                        <span className="font-medium text-gray-500 dark:text-gray-400">Website</span>
                        <p className="text-gray-900 dark:text-gray-100">{company.website}</p>
                      </div>
                    )}
                    {company.address && (
                      <div className="md:col-span-2">
                        <span className="font-medium text-gray-500 dark:text-gray-400">Address</span>
                        <p className="text-gray-900 dark:text-gray-100">{company.address}</p>
                        <p className="text-gray-600 dark:text-gray-400">{company.city}, {company.state} {company.zip}</p>
                      </div>
                    )}
                  </div>

                  {company.is_customer && (
                    <div className="mt-4 pt-4 border-t dark:border-gray-700 grid grid-cols-2 gap-4 text-sm">
                      {company.last_order_date && (
                        <div className="p-3 bg-blue-50 dark:bg-blue-900/30 rounded-lg">
                          <span className="font-medium text-gray-600 dark:text-gray-400">Last Order</span>
                          <p className="text-gray-900 dark:text-gray-100">
                            {new Date(company.last_order_date).toLocaleDateString()}
                            {daysSinceOrder !== null && <span className="ml-1 text-xs text-blue-600 dark:text-blue-400">({daysSinceOrder}d ago)</span>}
                          </p>
                        </div>
                      )}
                      {company.last_estimate_date && (
                        <div className="p-3 bg-green-50 dark:bg-green-900/30 rounded-lg">
                          <span className="font-medium text-gray-600 dark:text-gray-400">Last Estimate</span>
                          <p className="text-gray-900 dark:text-gray-100">
                            {new Date(company.last_estimate_date).toLocaleDateString()}
                            {daysSinceEstimate !== null && <span className="ml-1 text-xs text-green-600 dark:text-green-400">({daysSinceEstimate}d ago)</span>}
                          </p>
                        </div>
                      )}
                    </div>
                  )}
                </div>
              </div>

              {/* Right: Tags + Follow-up */}
              <div className="space-y-6">
                {/* Tags */}
                <div className="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                  <h3 className="text-sm font-semibold mb-3 text-gray-900 dark:text-gray-100 uppercase tracking-wide">Tags</h3>
                  <div className="flex flex-wrap gap-2 mb-3">
                    {companyTags.length === 0 && <span className="text-sm text-gray-400 dark:text-gray-500">No tags</span>}
                    {companyTags.map(tag => (
                      <span key={tag} className="inline-flex items-center gap-1 px-2 py-1 bg-indigo-100 dark:bg-indigo-900 text-indigo-700 dark:text-indigo-300 rounded text-sm">
                        {tag}
                        <button onClick={() => handleRemoveTag(tag)} className="ml-0.5 text-indigo-400 hover:text-indigo-700 dark:hover:text-indigo-200 font-bold">&times;</button>
                      </span>
                    ))}
                  </div>
                  <div className="flex gap-2">
                    <input
                      type="text"
                      value={newTag}
                      onChange={(e) => setNewTag(e.target.value)}
                      onKeyDown={(e) => e.key === 'Enter' && handleAddTag()}
                      placeholder="Add tag..."
                      className="flex-1 px-2 py-1 text-sm border dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                    />
                    <button
                      onClick={() => handleAddTag()}
                      disabled={savingTags || !newTag.trim()}
                      className="px-3 py-1 text-sm bg-indigo-600 text-white rounded hover:bg-indigo-700 disabled:opacity-50"
                    >
                      Add
                    </button>
                  </div>
                  {allSuggestions.length > 0 && (
                    <div className="mt-3">
                      <p className="text-xs text-gray-500 dark:text-gray-400 mb-1">Suggestions:</p>
                      <div className="flex flex-wrap gap-1">
                        {allSuggestions.slice(0, 8).map(tag => (
                          <button
                            key={tag}
                            onClick={() => handleAddTag(tag)}
                            className="px-2 py-0.5 text-xs bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 rounded hover:bg-indigo-100 dark:hover:bg-indigo-900 hover:text-indigo-700 dark:hover:text-indigo-300"
                          >
                            + {tag}
                          </button>
                        ))}
                      </div>
                    </div>
                  )}
                </div>

                {/* Follow-up Reminder */}
                <div className="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                  <h3 className="text-sm font-semibold mb-3 text-gray-900 dark:text-gray-100 uppercase tracking-wide">Follow-up Reminder</h3>
                  {company.follow_up_date && !editingFollowUp ? (
                    <div>
                      <div className={`p-3 rounded-lg ${isOverdue ? 'bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800' : 'bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-800'}`}>
                        <p className={`text-sm font-medium ${isOverdue ? 'text-red-700 dark:text-red-300' : 'text-blue-700 dark:text-blue-300'}`}>
                          {isOverdue ? 'OVERDUE' : 'Upcoming'}: {new Date(company.follow_up_date).toLocaleDateString()}
                        </p>
                        {company.follow_up_note && <p className="text-sm text-gray-600 dark:text-gray-400 mt-1">{company.follow_up_note}</p>}
                      </div>
                      <div className="flex gap-2 mt-2">
                        <button onClick={() => setEditingFollowUp(true)} className="text-sm text-blue-600 dark:text-blue-400 hover:underline">Edit</button>
                        <button onClick={handleClearFollowUp} className="text-sm text-red-600 dark:text-red-400 hover:underline">Clear</button>
                      </div>
                    </div>
                  ) : (
                    <div className="space-y-2">
                      {!editingFollowUp && !company.follow_up_date && (
                        <p className="text-sm text-gray-400 dark:text-gray-500 mb-2">No reminder set</p>
                      )}
                      <div>
                        <label className="block text-xs text-gray-500 dark:text-gray-400 mb-1">Date</label>
                        <input
                          type="date"
                          value={followUpDate}
                          onChange={(e) => { setFollowUpDate(e.target.value); setEditingFollowUp(true); }}
                          className="w-full px-2 py-1 text-sm border dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                        />
                      </div>
                      <div>
                        <label className="block text-xs text-gray-500 dark:text-gray-400 mb-1">Note (optional)</label>
                        <textarea
                          value={followUpNote}
                          onChange={(e) => { setFollowUpNote(e.target.value); setEditingFollowUp(true); }}
                          rows="2"
                          className="w-full px-2 py-1 text-sm border dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                          placeholder="Reminder note..."
                        />
                      </div>
                      {editingFollowUp && (
                        <div className="flex gap-2">
                          <button
                            onClick={handleSaveFollowUp}
                            disabled={savingFollowUp}
                            className="px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700 disabled:opacity-50"
                          >
                            {savingFollowUp ? 'Saving...' : 'Save'}
                          </button>
                          <button
                            onClick={() => {
                              setEditingFollowUp(false);
                              setFollowUpDate(company.follow_up_date ? company.follow_up_date.split('T')[0] : '');
                              setFollowUpNote(company.follow_up_note || '');
                            }}
                            className="px-3 py-1 text-sm border dark:border-gray-600 rounded hover:bg-gray-50 dark:hover:bg-gray-700"
                          >
                            Cancel
                          </button>
                        </div>
                      )}
                    </div>
                  )}
                </div>
              </div>
            </div>
          )}

          {/* Notes Section */}
          {activeSection === 'notes' && (
            <div className="space-y-4">
              {/* Add Note Form */}
              <div className="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
                <textarea
                  value={newNote}
                  onChange={(e) => setNewNote(e.target.value)}
                  rows="3"
                  className="w-full px-3 py-2 border dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                  placeholder="Add a note about this company..."
                />
                <div className="flex justify-end mt-2">
                  <button
                    onClick={handleAddNote}
                    disabled={savingNote || !newNote.trim()}
                    className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 text-sm flex items-center gap-2"
                  >
                    {savingNote ? <><Spinner size="sm" /> Adding...</> : 'Add Note'}
                  </button>
                </div>
              </div>

              {/* Conversation Log */}
              {notesArr.length === 0 ? (
                <div className="text-center py-8 text-gray-400 dark:text-gray-500">
                  No notes yet. Add the first note above.
                </div>
              ) : (
                <div className="space-y-3">
                  {notesArr.map((note) => (
                    <div key={note.id} className="bg-white dark:bg-gray-800 rounded-lg shadow p-4 flex gap-3">
                      <div className="flex-shrink-0 w-9 h-9 rounded-full bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 flex items-center justify-center text-sm font-bold">
                        {(note.author || '?')[0].toUpperCase()}
                      </div>
                      <div className="flex-1 min-w-0">
                        <div className="flex items-center gap-2 mb-1">
                          <span className="font-medium text-sm text-gray-900 dark:text-gray-100">{note.author}</span>
                          <span className="text-xs text-gray-400 dark:text-gray-500">
                            {note.timestamp ? new Date(note.timestamp).toLocaleString() : ''}
                          </span>
                        </div>
                        <p className="text-sm text-gray-700 dark:text-gray-300 whitespace-pre-wrap">{note.text}</p>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          )}

          {/* Activities Section */}
          {activeSection === 'activities' && (
            <div className="space-y-3">
              {companyActivities.length === 0 ? (
                <div className="text-center py-8 text-gray-400 dark:text-gray-500">
                  No activities logged yet. Click "Log Activity" to add one.
                </div>
              ) : (
                companyActivities.map((activity) => {
                  const emp = employees.find(e => e.id === activity.employee_id);
                  return (
                    <div key={activity.id} className="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
                      <div className="flex justify-between items-start">
                        <div className="flex-1">
                          <div className="flex items-center gap-2 mb-2">
                            <span className={`px-2 py-0.5 rounded text-xs font-medium ${
                              activity.type === 'call'
                                ? 'bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200'
                                : 'bg-purple-100 dark:bg-purple-900 text-purple-800 dark:text-purple-200'
                            }`}>
                              {activity.type === 'call' ? 'üìû Call' : '‚úâÔ∏è Email'}
                            </span>
                            <span className="text-sm text-gray-600 dark:text-gray-400">by {emp?.name || 'Unknown'}</span>
                          </div>
                          <div className="flex gap-2 flex-wrap mb-1">
                            {activity.answered && <span className="px-2 py-0.5 text-xs bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 rounded">Answered</span>}
                            {activity.interested && <span className="px-2 py-0.5 text-xs bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 rounded">Interested</span>}
                            {activity.follow_up && <span className="px-2 py-0.5 text-xs bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200 rounded">Follow-up</span>}
                          </div>
                          {activity.notes && <p className="text-sm text-gray-700 dark:text-gray-300 mt-1">{activity.notes}</p>}
                        </div>
                        <span className="text-xs text-gray-500 dark:text-gray-400 whitespace-nowrap ml-3">
                          {new Date(activity.date).toLocaleDateString()}
                        </span>
                      </div>
                    </div>
                  );
                })
              )}
            </div>
          )}

          {/* Edit Modal */}
          {showEditModal && (
            <CompanyEditModal
              company={company}
              onClose={() => setShowEditModal(false)}
              onSave={async () => { setShowEditModal(false); await onRefresh(); }}
            />
          )}

          {/* Activity Modal */}
          {showActivityModal && (
            <ActivityModal
              company={company}
              employees={employees}
              user={user}
              onClose={() => setShowActivityModal(false)}
              onSave={async () => { setShowActivityModal(false); await onRefresh(); }}
            />
          )}

          {/* Email Modal */}
          {showEmailModal && (
            <EmailCompose
              company={company}
              user={user}
              onClose={() => setShowEmailModal(false)}
              onSent={async () => { setShowEmailModal(false); await onRefresh(); }}
            />
          )}
        </div>
      );
    }

    // Email Compose Modal
    function EmailCompose({ company, user, onClose, onSent }) {
      const [templates, setTemplates] = useState([]);
      const [selectedTemplate, setSelectedTemplate] = useState('');
      const [to, setTo] = useState(company.email || '');
      const [subject, setSubject] = useState('');
      const [body, setBody] = useState('');
      const [sending, setSending] = useState(false);
      const [error, setError] = useState('');
      const [success, setSuccess] = useState(false);

      useEffect(() => {
        api.getEmailTemplates().then(t => {
          setTemplates(t);
        }).catch(() => {});
      }, []);

      const applyTemplate = (templateId) => {
        setSelectedTemplate(templateId);
        const tmpl = templates.find(t => t.id === templateId);
        if (!tmpl) return;

        const contactName = company.contact_name || company.name;
        const senderName = user.name || 'Team Member';

        setSubject(tmpl.subject);
        setBody(
          tmpl.body
            .replace(/\{\{contact_name\}\}/g, contactName)
            .replace(/\{\{sender_name\}\}/g, senderName)
            .replace(/\{\{company_name\}\}/g, company.name)
        );
      };

      const handleSend = async () => {
        if (!to.trim()) { setError('Recipient email is required'); return; }
        if (!subject.trim()) { setError('Subject is required'); return; }
        if (!body.trim()) { setError('Email body is required'); return; }

        setSending(true);
        setError('');
        try {
          await api.sendEmail({
            to: to.trim(),
            subject: subject.trim(),
            body: body,
            company_id: company.id
          });
          setSuccess(true);
          setTimeout(() => onSent(), 1500);
        } catch (err) {
          setError(err.message || 'Failed to send email');
        } finally {
          setSending(false);
        }
      };

      // Convert HTML to plain text for textarea display
      const htmlToText = (html) => {
        return html
          .replace(/<br\s*\/?>/gi, '\n')
          .replace(/<\/p>/gi, '\n\n')
          .replace(/<\/li>/gi, '\n')
          .replace(/<li[^>]*>/gi, '  ‚Ä¢ ')
          .replace(/<\/ul>/gi, '\n')
          .replace(/<\/ol>/gi, '\n')
          .replace(/<[^>]+>/g, '')
          .replace(/&amp;/g, '&')
          .replace(/&lt;/g, '<')
          .replace(/&gt;/g, '>')
          .replace(/&mdash;/g, '‚Äî')
          .replace(/&nbsp;/g, ' ')
          .replace(/\n{3,}/g, '\n\n')
          .trim();
      };

      // Convert plain text back to HTML for sending
      const textToHtml = (text) => {
        return text
          .split('\n\n')
          .map(para => `<p>${para.replace(/\n/g, '<br/>')}</p>`)
          .join('\n');
      };

      const displayBody = body.includes('<') ? htmlToText(body) : body;

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white dark:bg-gray-800 rounded-xl shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            {/* Header */}
            <div className="flex justify-between items-center px-6 py-4 border-b border-gray-200 dark:border-gray-700">
              <h3 className="text-xl font-bold text-gray-900 dark:text-gray-100">Send Email - {company.name}</h3>
              <button onClick={onClose} className="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 text-2xl">&times;</button>
            </div>

            {/* Body */}
            <div className="p-6 space-y-4 overflow-y-auto flex-1">
              {success ? (
                <div className="text-center py-8">
                  <div className="text-5xl mb-4">‚úÖ</div>
                  <h4 className="text-xl font-semibold text-green-600 dark:text-green-400">Email Sent!</h4>
                  <p className="text-gray-600 dark:text-gray-400 mt-2">Email to {to} has been sent and logged as an activity.</p>
                </div>
              ) : (
                <>
                  {/* Template Selector */}
                  <div>
                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Template</label>
                    <select
                      value={selectedTemplate}
                      onChange={(e) => applyTemplate(e.target.value)}
                      className="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                    >
                      <option value="">-- Select a template or write custom --</option>
                      {templates.map(t => (
                        <option key={t.id} value={t.id}>{t.name}</option>
                      ))}
                    </select>
                  </div>

                  {/* To */}
                  <div>
                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">To</label>
                    <input
                      type="email"
                      value={to}
                      onChange={(e) => setTo(e.target.value)}
                      placeholder="recipient@example.com"
                      className="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                    />
                    {!to && company.email && (
                      <p className="text-xs text-gray-500 dark:text-gray-400 mt-1">Pre-filled from company email</p>
                    )}
                  </div>

                  {/* Subject */}
                  <div>
                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Subject</label>
                    <input
                      type="text"
                      value={subject}
                      onChange={(e) => setSubject(e.target.value)}
                      placeholder="Email subject"
                      className="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                    />
                  </div>

                  {/* Body */}
                  <div>
                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Body</label>
                    <textarea
                      value={displayBody}
                      onChange={(e) => setBody(textToHtml(e.target.value))}
                      rows={14}
                      placeholder="Type your email message here..."
                      className="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 font-mono text-sm"
                    />
                  </div>

                  {/* Error */}
                  {error && (
                    <div className="bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800 rounded-lg p-3 text-red-700 dark:text-red-300 text-sm">
                      {error}
                    </div>
                  )}
                </>
              )}
            </div>

            {/* Footer */}
            {!success && (
              <div className="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-3">
                <button
                  onClick={onClose}
                  className="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 text-sm"
                >
                  Cancel
                </button>
                <button
                  onClick={handleSend}
                  disabled={sending}
                  className="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:bg-purple-400 text-sm flex items-center gap-2"
                >
                  {sending ? <><Spinner size="sm" /> Sending...</> : 'Send Email'}
                </button>
              </div>
            )}
          </div>
        </div>
      );
    }

    // Discover Component - Find new companies via Google Places
    function Discover({ companies, onRefresh, onViewCompany }) {
      const [searchMode, setSearchMode] = useState('industry');
      const [industry, setIndustry] = useState('Fencing');
      const [companyName, setCompanyName] = useState('');
      const [location, setLocation] = useState('');
      const [results, setResults] = useState([]);
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');
      const [addingId, setAddingId] = useState(null);
      const [addedIds, setAddedIds] = useState(new Set());

      const industries = [
        'Fencing',
        'Landscaping',
        'Hardscaping',
        'Construction',
        'Handyman',
        'Deck Building',
        'Paving',
        'Excavation',
        'Concrete',
        'Roofing'
      ];

      const handleSearch = async () => {
        if (searchMode === 'name' && !companyName.trim()) {
          setError('Please enter a company name to search for');
          return;
        }
        if (searchMode === 'industry' && !location.trim()) {
          setError('Please enter a location (city, state, or zip code)');
          return;
        }
        setLoading(true);
        setError('');
        setResults([]);
        setAddedIds(new Set());
        try {
          const query = searchMode === 'name' ? companyName.trim() : `${industry} companies`;
          const loc = searchMode === 'name' ? location.trim() : location.trim();
          const data = await api.discoverCompanies(query, loc);
          setResults(data);
          if (data.length === 0) {
            setError(searchMode === 'name'
              ? 'No results found. Try a different name or add a location to narrow it down.'
              : 'No results found. Try a different location or industry.');
          }
        } catch (err) {
          setError(err.message || 'Search failed. Please try again.');
        } finally {
          setLoading(false);
        }
      };

      const handleAddToCRM = async (place) => {
        setAddingId(place.google_place_id);
        try {
          await api.createCompany({
            id: `company_${Date.now()}`,
            name: place.name,
            phone: place.phone,
            address: place.street,
            city: place.city,
            state: place.state,
            zip: place.zip,
            website: place.website,
            type: 'Prospect',
            notes: JSON.stringify([{
              id: Date.now().toString(),
              author: 'System',
              text: `Imported from Google Places. Rating: ${place.rating || 'N/A'} (${place.ratingCount} reviews). Full address: ${place.address}`,
              timestamp: new Date().toISOString()
            }]),
            tags: JSON.stringify(searchMode === 'industry' ? [industry] : [])
          });
          setAddedIds(prev => new Set([...prev, place.google_place_id]));
          await onRefresh();
        } catch (err) {
          alert('Failed to add company: ' + (err.message || 'Unknown error'));
        } finally {
          setAddingId(null);
        }
      };

      return (
        <div>
          <div className="flex items-center justify-between mb-6">
            <h2 className="text-2xl font-bold text-gray-900 dark:text-gray-100">Discover Companies</h2>
          </div>

          {/* Search Form */}
          <div className="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6 mb-6">
            {/* Search Mode Toggle */}
            <div className="flex gap-2 mb-4">
              <button
                onClick={() => setSearchMode('industry')}
                className={`px-4 py-1.5 rounded-full text-sm font-medium transition-colors ${
                  searchMode === 'industry'
                    ? 'bg-blue-600 text-white'
                    : 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600'
                }`}
              >
                By Industry
              </button>
              <button
                onClick={() => setSearchMode('name')}
                className={`px-4 py-1.5 rounded-full text-sm font-medium transition-colors ${
                  searchMode === 'name'
                    ? 'bg-blue-600 text-white'
                    : 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600'
                }`}
              >
                By Name
              </button>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              {searchMode === 'industry' ? (
                <div>
                  <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Industry</label>
                  <select
                    value={industry}
                    onChange={(e) => setIndustry(e.target.value)}
                    className="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  >
                    {industries.map(ind => (
                      <option key={ind} value={ind}>{ind}</option>
                    ))}
                  </select>
                </div>
              ) : (
                <div>
                  <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Company Name</label>
                  <input
                    type="text"
                    value={companyName}
                    onChange={(e) => setCompanyName(e.target.value)}
                    onKeyDown={(e) => e.key === 'Enter' && handleSearch()}
                    placeholder="e.g. Smith's Fencing"
                    className="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  />
                </div>
              )}
              <div>
                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                  Location {searchMode === 'name' && <span className="text-gray-400 font-normal">(optional)</span>}
                </label>
                <input
                  type="text"
                  value={location}
                  onChange={(e) => setLocation(e.target.value)}
                  onKeyDown={(e) => e.key === 'Enter' && handleSearch()}
                  placeholder="City, State or Zip Code (e.g. Wilmington, DE)"
                  className="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                />
              </div>
              <div className="flex items-end">
                <button
                  onClick={handleSearch}
                  disabled={loading}
                  className="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-blue-400 text-white font-medium py-2 px-4 rounded-lg transition-colors flex items-center justify-center gap-2"
                >
                  {loading ? <><Spinner size="sm" /> Searching...</> : 'üîç Search'}
                </button>
              </div>
            </div>
            <p className="text-xs text-gray-500 dark:text-gray-400 mt-2">
              {searchMode === 'industry'
                ? `Search for ${industry.toLowerCase()} companies near a specific location. Results are powered by Google Places.`
                : 'Search for a specific company by name. Add a location to narrow results.'}
            </p>
          </div>

          {/* Error Message */}
          {error && (
            <div className="bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800 rounded-lg p-4 mb-6 text-red-700 dark:text-red-300">
              {error}
            </div>
          )}

          {/* Results */}
          {results.length > 0 && (
            <div className="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
              <div className="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
                <h3 className="font-semibold text-gray-900 dark:text-gray-100">
                  Found {results.length} {industry} companies near {location}
                </h3>
                <span className="text-sm text-gray-500 dark:text-gray-400">
                  {results.filter(r => r.alreadyInCRM || addedIds.has(r.google_place_id)).length} already in CRM
                </span>
              </div>
              <div className="divide-y divide-gray-200 dark:divide-gray-700">
                {results.map((place) => {
                  const inCRM = place.alreadyInCRM || addedIds.has(place.google_place_id);
                  return (
                    <div key={place.google_place_id} className="px-6 py-4 flex items-start justify-between gap-4">
                      <div className="flex-1 min-w-0">
                        <div className="flex items-center gap-2 flex-wrap">
                          <h4 className="font-semibold text-gray-900 dark:text-gray-100">{place.name}</h4>
                          {place.rating && (
                            <span className="text-sm text-yellow-600 dark:text-yellow-400 flex items-center gap-1">
                              ‚≠ê {place.rating}
                              <span className="text-gray-500 dark:text-gray-400">({place.ratingCount})</span>
                            </span>
                          )}
                          {inCRM && (
                            <span className="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 dark:bg-green-900/40 text-green-800 dark:text-green-300">
                              In CRM
                            </span>
                          )}
                        </div>
                        <p className="text-sm text-gray-600 dark:text-gray-400 mt-1">{place.address}</p>
                        <div className="flex items-center gap-4 mt-2 flex-wrap">
                          {place.phone && (
                            <a href={`tel:${place.phone}`} className="text-sm text-blue-600 dark:text-blue-400 hover:underline">
                              üìû {place.phone}
                            </a>
                          )}
                          {place.website && (
                            <a href={place.website} target="_blank" rel="noopener noreferrer" className="text-sm text-blue-600 dark:text-blue-400 hover:underline truncate max-w-xs">
                              üåê {place.website.replace(/^https?:\/\/(www\.)?/, '').replace(/\/$/, '')}
                            </a>
                          )}
                        </div>
                      </div>
                      <div className="flex-shrink-0">
                        {inCRM ? (
                          <button
                            disabled
                            className="px-4 py-2 text-sm font-medium rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-500 dark:text-gray-400 cursor-not-allowed"
                          >
                            Added ‚úì
                          </button>
                        ) : (
                          <button
                            onClick={() => handleAddToCRM(place)}
                            disabled={addingId === place.google_place_id}
                            className="px-4 py-2 text-sm font-medium rounded-lg bg-green-600 hover:bg-green-700 disabled:bg-green-400 text-white transition-colors flex items-center gap-2"
                          >
                            {addingId === place.google_place_id ? (
                              <><Spinner size="sm" /> Adding...</>
                            ) : (
                              '+ Add to CRM'
                            )}
                          </button>
                        )}
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          )}

          {/* Empty State */}
          {!loading && results.length === 0 && !error && (
            <div className="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-12 text-center">
              <div className="text-4xl mb-4">üîç</div>
              <h3 className="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-2">Find New Companies</h3>
              <p className="text-gray-600 dark:text-gray-400 max-w-md mx-auto">
                Search for fencing, landscaping, hardscaping, construction, and other companies in any area to add to your CRM.
              </p>
            </div>
          )}
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
